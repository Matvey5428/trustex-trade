<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TrustEx - Terminal</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="js/i18n.js" defer></script>
  <script src="js/auth.js?v=2" defer></script>
  <script src="js/api.js" defer></script>
  <script src="js/balance.js" defer></script>
  <style>body { opacity: 0; } body.i18n-ready { opacity: 1; transition: opacity 0.15s ease-out; }</style>
  <script>(function() { var lang = localStorage.getItem('nexo_lang') || 'ru'; document.documentElement.lang = lang; setTimeout(function() { document.body && document.body.classList.add('i18n-ready'); }, 500); document.addEventListener('gesturestart', function(e) { e.preventDefault(); }); document.addEventListener('gesturechange', function(e) { e.preventDefault(); }); document.addEventListener('gestureend', function(e) { e.preventDefault(); }); document.addEventListener('touchstart', function(e) { if(e.touches.length > 1) e.preventDefault(); }, { passive: false }); })();</script>
  <style>
    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-card: #1c2128;
      --bg-hover: #262c36;
      --accent: #00d4aa;
      --accent-dim: rgba(0, 212, 170, 0.1);
      --text-primary: #f0f6fc;
      --text-secondary: #8b949e;
      --text-muted: #6e7681;
      --border-color: #30363d;
      --success: #3fb950;
      --danger: #f85149;
      --warning: #d29922;
    }
    
    * { box-sizing: border-box; }
    html, body {
      touch-action: pan-x pan-y;
      -ms-touch-action: pan-x pan-y;
    }
    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      padding-bottom: 80px;
    }
    
    .app-container {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
    }
    
    /* Header */
    .terminal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      margin-bottom: 16px;
    }
    
    .back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 14px;
      padding: 8px 12px;
      background: var(--bg-card);
      border-radius: 10px;
      border: 1px solid var(--border-color);
      transition: all 0.2s;
    }
    
    .back-btn:hover {
      color: var(--text-primary);
      background: var(--bg-hover);
    }
    
    .lang-selector {
      display: flex;
      background: var(--bg-card);
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid var(--border-color);
    }
    
    .lang-btn {
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .lang-btn.active {
      background: var(--accent);
      color: #000;
    }
    
    /* Pair Info Card */
    .pair-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      border: 1px solid var(--border-color);
    }
    
    .pair-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .pair-icon {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, var(--accent) 0%, #00a884 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      color: #000;
    }
    
    .pair-name {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 2px;
    }
    
    .pair-subtitle {
      color: var(--text-secondary);
      font-size: 12px;
    }
    
    .pair-price {
      font-weight: 700;
      font-size: 18px;
      text-align: right;
    }
    
    .pair-change {
      font-size: 13px;
      font-weight: 500;
      text-align: right;
    }
    
    .pair-change.positive { color: var(--success); }
    .pair-change.negative { color: var(--danger); }
    
    /* Info Row */
    .info-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .info-box {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 14px;
      border: 1px solid var(--border-color);
    }
    
    .info-label {
      color: var(--text-secondary);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }
    
    .info-value {
      font-weight: 600;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .percent-badge {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 6px;
      font-weight: 500;
    }
    
    .badge-green { background: rgba(63, 185, 80, 0.15); color: var(--success); }
    .badge-red { background: rgba(248, 81, 73, 0.15); color: var(--danger); }
    
    /* Chart */
    .chart-container {
      background: var(--bg-card);
      border-radius: 16px;
      height: 320px;
      margin-bottom: 12px;
      overflow: hidden;
      border: 1px solid var(--border-color);
    }
    
    /* Timeframe buttons */
    .tf-group {
      display: flex;
      gap: 6px;
      margin-bottom: 16px;
      overflow-x: auto;
      padding-bottom: 4px;
    }
    
    .tf-btn {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      padding: 10px 16px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .tf-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }
    
    .tf-btn.active {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
    }
    
    /* Trade Buttons */
    .trade-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 24px;
    }
    
    .btn-trade {
      padding: 18px;
      border-radius: 14px;
      border: none;
      font-weight: 700;
      font-size: 16px;
      color: #fff;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-trade:active {
      transform: scale(0.97);
    }
    
    .btn-up {
      background: linear-gradient(135deg, #3fb950 0%, #2ea043 100%);
      box-shadow: 0 4px 20px rgba(63, 185, 80, 0.3);
    }
    
    .btn-down {
      background: linear-gradient(135deg, #f85149 0%, #da3633 100%);
      box-shadow: 0 4px 20px rgba(248, 81, 73, 0.3);
    }
    
    /* Trade History */
    .section-title {
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }
    
    .trade-item {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 14px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      border: 1px solid var(--border-color);
      transition: all 0.2s;
    }
    
    .trade-item.active {
      border-color: var(--accent);
      background: var(--accent-dim);
    }
    
    .trade-amount {
      font-weight: 600;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .trade-amount.win { color: var(--success); }
    .trade-amount.loss { color: var(--danger); }
    
    .trade-date {
      color: var(--text-secondary);
      font-size: 12px;
      margin-top: 4px;
    }
    
    .trade-status {
      font-size: 12px;
      font-weight: 500;
      padding: 4px 10px;
      border-radius: 6px;
    }
    
    .trade-status.active { background: rgba(0, 212, 170, 0.15); color: var(--accent); }
    .trade-status.win { background: rgba(63, 185, 80, 0.15); color: var(--success); }
    .trade-status.loss { background: rgba(248, 81, 73, 0.15); color: var(--danger); }
    
    .trade-timer {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
    }
    
    .empty-trades {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    /* Trade Panel */
    .panel-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      display: none;
      z-index: 9999;
    }
    
    .trade-panel {
      position: fixed;
      bottom: -100%;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border-top-left-radius: 24px;
      border-top-right-radius: 24px;
      padding: 24px;
      z-index: 10000;
      transition: bottom 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      max-width: 480px;
      margin: 0 auto;
    }
    
    .trade-panel.active {
      bottom: 0;
    }
    
    .panel-handle {
      width: 40px;
      height: 4px;
      background: var(--border-color);
      border-radius: 2px;
      margin: 0 auto 20px;
    }
    
    .panel-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .panel-title .arrow-up { color: var(--success); }
    .panel-title .arrow-down { color: var(--danger); }
    
    .balance-alert {
      background: rgba(248, 81, 73, 0.15);
      border: 1px solid var(--danger);
      color: var(--danger);
      padding: 12px;
      border-radius: 12px;
      font-size: 13px;
      text-align: center;
      margin-bottom: 16px;
      display: none;
    }
    
    .input-group-custom {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid var(--border-color);
    }
    
    .input-label {
      color: var(--text-secondary);
      font-size: 12px;
      margin-bottom: 8px;
    }
    
    .input-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .input-field {
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-size: 22px;
      font-weight: 600;
      width: 70%;
      outline: none;
    }
    
    .input-currency {
      color: var(--accent);
      font-weight: 600;
      font-size: 16px;
    }
    
    .available-balance {
      color: var(--text-secondary);
      font-size: 12px;
      margin-bottom: 16px;
    }
    
    .available-balance span {
      color: var(--text-primary);
    }
    
    /* Time Grid */
    .time-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .time-btn {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .time-btn:hover {
      background: var(--bg-hover);
    }
    
    .time-btn.active {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
    }
    
    .panel-submit {
      width: 100%;
      padding: 18px;
      border-radius: 14px;
      border: none;
      font-weight: 700;
      font-size: 16px;
      color: #fff;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .panel-submit.up {
      background: linear-gradient(135deg, #3fb950 0%, #2ea043 100%);
    }
    
    .panel-submit.down {
      background: linear-gradient(135deg, #f85149 0%, #da3633 100%);
    }
    
    .panel-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    /* Bottom Nav */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      z-index: 9998;
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 11px;
      padding: 4px 16px;
      transition: all 0.2s;
    }
    
    .nav-item.active {
      color: var(--accent);
    }
    
    .nav-icon {
      font-size: 20px;
    }
    
    /* Animations */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    @keyframes slideIn {
      from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    
    @keyframes slideOut {
      from { transform: translateX(-50%) translateY(0); opacity: 1; }
      to { transform: translateX(-50%) translateY(-20px); opacity: 0; }
    }
    
    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 16px 24px;
      border-radius: 14px;
      font-weight: 600;
      z-index: 99999;
      animation: slideIn 0.3s ease;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
    }
    
    .notification.win {
      background: linear-gradient(135deg, #3fb950 0%, #2ea043 100%);
      color: #fff;
    }
    
    .notification.loss {
      background: linear-gradient(135deg, #f85149 0%, #da3633 100%);
      color: #fff;
    }
    
    .notification.info {
      background: linear-gradient(135deg, var(--accent) 0%, #00a884 100%);
      color: #000;
    }
    
    /* Bottom Navigation Bar */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 9999;
      background: linear-gradient(180deg, #161b22 0%, #0d1117 100%);
      border-top: 1px solid rgba(48, 54, 61, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 6px 0 max(6px, env(safe-area-inset-bottom));
      display: flex;
      justify-content: space-around;
      align-items: center;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      color: #6e7681;
      padding: 8px 12px;
      border-radius: 12px;
      transition: all 0.15s ease;
      min-width: 64px;
      position: relative;
      -webkit-tap-highlight-color: transparent;
    }

    .nav-item:hover { color: #8b949e; }
    .nav-item.active { color: var(--accent); }

    .nav-item.active::before {
      content: '';
      position: absolute;
      top: -6px;
      left: 50%;
      transform: translateX(-50%);
      width: 20px;
      height: 2px;
      background: var(--accent);
      border-radius: 2px;
    }

    .nav-icon {
      width: 24px;
      height: 24px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-icon svg {
      width: 22px;
      height: 22px;
      fill: currentColor;
    }

    .nav-item:active .nav-icon { transform: scale(0.92); }
    .nav-label { font-size: 10px; font-weight: 500; }
    .nav-item.active .nav-label { font-weight: 600; }
  </style>
</head>
<body>

<div class="app-container">
  <!-- Header -->
  <div class="terminal-header">
    <a href="trading.html" class="back-btn">
      <span>‚Üê</span>
      <span data-i18n="back">Back</span>
    </a>
    <div class="lang-selector">
      <button class="lang-btn active" onclick="switchLang('en')">EN</button>
      <button class="lang-btn" onclick="switchLang('ru')">RU</button>
    </div>
  </div>

  <!-- Pair Card -->
  <div class="pair-card">
    <div class="pair-left">
      <div class="pair-icon" id="coinIcon">X</div>
      <div>
        <div class="pair-name" id="pairName">XRP / USDT</div>
        <div class="pair-subtitle" data-i18n="cryptocurrency">Cryptocurrency</div>
      </div>
    </div>
    <div>
      <div class="pair-price" id="pairPriceDisplay">0.00</div>
      <div class="pair-change negative" id="pairChangeDisplay">0.00%</div>
    </div>
  </div>

  <!-- Info Row -->
  <div class="info-row">
    <div class="info-box">
      <div class="info-label" data-i18n="balance">Balance</div>
      <div class="info-value" id="userUsdtBalance">0.00 USDT</div>
    </div>
    <div class="info-box">
      <div class="info-label">Live Price</div>
      <div class="info-value">
        <span id="livePrice">0.00</span>
        <span class="percent-badge badge-red" id="liveChange">0.00%</span>
      </div>
    </div>
  </div>

  <!-- Chart -->
  <div class="chart-container" id="tradingview_widget"></div>

  <!-- Timeframes -->
  <div class="tf-group">
    <button class="tf-btn active" data-tf="1" onclick="changeInterval(this)">1M</button>
    <button class="tf-btn" data-tf="5" onclick="changeInterval(this)">5M</button>
    <button class="tf-btn" data-tf="15" onclick="changeInterval(this)">15M</button>
    <button class="tf-btn" data-tf="30" onclick="changeInterval(this)">30M</button>
    <button class="tf-btn" data-tf="60" onclick="changeInterval(this)">1H</button>
    <button class="tf-btn" data-tf="D" onclick="changeInterval(this)">1D</button>
  </div>

  <!-- Trade Actions -->
  <div class="trade-actions">
    <button class="btn-trade btn-up" onclick="openTrade('buy')">
      <span>‚Üë</span>
      <span data-i18n="up">UP</span>
    </button>
    <button class="btn-trade btn-down" onclick="openTrade('sell')">
      <span>‚Üì</span>
      <span data-i18n="down">DOWN</span>
    </button>
  </div>

  <!-- Trade History -->
  <div class="section-title" data-i18n="tradeHistory">Trade History</div>
  <div id="activeTradesContainer">
    <div class="empty-trades" data-i18n="noTrades">No trades yet</div>
  </div>
</div>

<!-- Bottom Navigation -->
<div class="bottom-nav">
  <a href="index.html" class="nav-item">
    <span class="nav-icon">üíº</span>
    <span data-i18n="assets">Assets</span>
  </a>
  <a href="trading.html" class="nav-item active">
    <span class="nav-icon">üìä</span>
    <span data-i18n="trading">Trading</span>
  </a>
  <a href="exchange.html" class="nav-item">
    <span class="nav-icon">üîÑ</span>
    <span data-i18n="exchange">Exchange</span>
  </a>
</div>

<!-- Trade Panel Overlay -->
<div class="panel-overlay" id="panelOverlay" onclick="closeTrade()"></div>

<!-- Trade Panel -->
<div class="trade-panel" id="tradePanel">
  <div class="panel-handle"></div>
  
  <div class="balance-alert" id="balanceAlert" data-i18n="insufficientBalance">
    Insufficient balance
  </div>
  
  <div class="panel-title" id="panelTitle">
    <span class="arrow-up">‚Üë</span>
    <span data-i18n="predictUp">Predict: UP</span>
  </div>
  
  <div class="input-group-custom">
    <div class="input-label" data-i18n="investmentAmount">Investment Amount (USDT)</div>
    <div class="input-row">
      <input type="number" class="input-field" id="tradeAmount" placeholder="10.00">
      <span class="input-currency">USDT</span>
    </div>
  </div>
  
  <div class="available-balance">
    <span data-i18n="available">Available</span>: <span id="panelAvailableUsdt">0.00 USDT</span>
  </div>
  
  <div class="input-label" style="margin-bottom: 10px;" data-i18n="duration">Duration</div>
  <div class="time-grid" id="timeSelection">
    <button class="time-btn active" onclick="setTime(this)">30s</button>
    <button class="time-btn" onclick="setTime(this)">1m</button>
    <button class="time-btn" onclick="setTime(this)">2m</button>
    <button class="time-btn" onclick="setTime(this)">5m</button>
    <button class="time-btn" onclick="setTime(this)">15m</button>
    <button class="time-btn" onclick="setTime(this)">30m</button>
  </div>
  
  <button class="panel-submit up" id="panelSubmitBtn" onclick="executeTrade()" data-i18n="openTrade">
    Open Trade
  </button>
</div>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

<script>
  const tg = window.Telegram?.WebApp;
  let userId = null;
  const params = new URLSearchParams(window.location.search);
  const coinSymbol = params.get('symbol') || 'BTC';
  let currentTradeType = 'buy';
  let widget = null;

  // Language switcher
  function switchLang(lang) {
    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    if (typeof applyLanguage === 'function') {
      applyLanguage(lang);
    }
  }

  // Initialize language
  document.addEventListener('DOMContentLoaded', () => {
    const savedLang = localStorage.getItem('nexo_lang') || 'en';
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.classList.toggle('active', btn.textContent.toLowerCase() === savedLang);
    });
  });

  function getClientTelegramId() {
    const telegramRawId = tg?.initDataUnsafe?.user?.id;
    if (telegramRawId) return Number(telegramRawId);
    const key = 'nexo_guest_telegram_id';
    const stored = localStorage.getItem(key);
    if (stored) return Number(stored);
    const generated = Math.floor(800000000 + Math.random() * 100000000);
    localStorage.setItem(key, String(generated));
    return generated;
  }

  async function resolveUserId() {
    const telegramId = getClientTelegramId();
    const res = await fetch('/api/user', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ telegramId })
    });
    const payload = await res.json();
    if (!res.ok || !payload?.data?.telegram_id) {
      throw new Error(payload?.error || 'Failed to get account');
    }
    return payload.data.telegram_id;
  }

  function initChart(interval = '1') {
    const lang = localStorage.getItem('nexo_lang') || 'en';
    widget = new TradingView.widget({
      "autosize": true,
      "symbol": `BINANCE:${coinSymbol}USDT`,
      "interval": interval,
      "timezone": "Etc/UTC",
      "theme": "dark",
      "style": "1",
      "locale": lang === 'ru' ? 'ru' : 'en',
      "toolbar_bg": "#0d1117",
      "enable_publishing": false,
      "hide_top_toolbar": true,
      "save_image": false,
      "container_id": "tradingview_widget"
    });
  }

  function changeInterval(btn) {
    document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    initChart(btn.getAttribute('data-tf'));
  }

  async function loadUserBalance() {
    if (!userId) return;
    try {
      const res = await fetch(`/api/profile/${userId}`);
      if (!res.ok) throw new Error("Server error");
      const payload = await res.json();
      const data = payload?.data || {};
      
      const usdt = parseFloat(data.usdt || 0);
      const formatted = usdt.toLocaleString(undefined, { minimumFractionDigits: 2 });
      
      document.getElementById('userUsdtBalance').textContent = `${formatted} USDT`;
      document.getElementById('panelAvailableUsdt').textContent = `${formatted} USDT`;
    } catch (e) {
      console.error("Balance error:", e);
      document.getElementById('userUsdtBalance').textContent = "Network error";
    }
  }

  async function updateLivePrice() {
    try {
      const res = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${coinSymbol}USDT`);
      const data = await res.json();
      const price = parseFloat(data.lastPrice).toFixed(coinSymbol === 'PEPE' ? 8 : 4);
      const change = parseFloat(data.priceChangePercent).toFixed(2);
      
      document.getElementById('livePrice').textContent = price;
      document.getElementById('pairPriceDisplay').textContent = `$${price}`;
      
      const changeEl = document.getElementById('liveChange');
      const changeDisplayEl = document.getElementById('pairChangeDisplay');
      const text = `${change > 0 ? '+' : ''}${change}%`;
      
      changeEl.textContent = text;
      changeDisplayEl.textContent = text;
      changeEl.className = `percent-badge ${change >= 0 ? 'badge-green' : 'badge-red'}`;
      changeDisplayEl.className = `pair-change ${change >= 0 ? 'positive' : 'negative'}`;
    } catch (e) {
      console.error("Price error:", e);
    }
  }

  async function loadActiveTrades() {
    if (!userId) return;
    const container = document.getElementById('activeTradesContainer');
    const lang = localStorage.getItem('nexo_lang') || 'en';
    
    try {
      const res = await fetch(`/api/trades/history/${userId}?symbol=${coinSymbol}`);
      const payload = await res.json();
      const trades = Array.isArray(payload?.data) ? payload.data : [];

      if (!trades.length) {
        const noTradesText = lang === 'ru' ? '–ù–µ—Ç —Å–¥–µ–ª–æ–∫' : 'No trades yet';
        container.innerHTML = `<div class="empty-trades">${noTradesText}</div>`;
        return;
      }

      container.innerHTML = trades.slice(0, 10).map((trade) => {
        const isActive = trade.status === 'active';
        const isWin = trade.status === 'successful';
        
        const sign = isWin ? '+' : '-';
        const statusClass = isActive ? 'active' : (isWin ? 'win' : 'loss');
        const statusText = isActive ? (lang === 'ru' ? '–∞–∫—Ç–∏–≤–Ω–æ' : 'active') : 
                          (isWin ? (lang === 'ru' ? '–≤—ã–∏–≥—Ä—ã—à' : 'win') : (lang === 'ru' ? '–ø—Ä–æ–∏–≥—Ä—ã—à' : 'loss'));
        
        const arrow = trade.direction === 'up' ? '‚Üë' : '‚Üì';
        const arrowColor = trade.direction === 'up' ? 'var(--success)' : 'var(--danger)';
        
        const created = trade.createdAt ? new Date(trade.createdAt) : new Date();
        const dateLocale = lang === 'ru' ? 'ru-RU' : 'en-US';
        
        let expiresAt = trade.expiresAt;
        if (isActive && !expiresAt && trade.duration) {
          const createdTime = new Date(trade.createdAt).getTime();
          expiresAt = new Date(createdTime + trade.duration * 1000).toISOString();
        }
        
        if (isActive && expiresAt) {
          const tradeId = trade.id;
          return `
            <div class="trade-item active" id="trade-${tradeId}">
              <div>
                <div class="trade-amount">
                  ${Number(trade.fromAmount || 0).toFixed(2)} USDT 
                  <span style="color: ${arrowColor}; font-size: 18px;">${arrow}</span>
                </div>
                <div class="trade-date">${created.toLocaleDateString(dateLocale)} ${created.toLocaleTimeString(dateLocale, { hour: '2-digit', minute: '2-digit' })}</div>
              </div>
              <div style="text-align: right;">
                <div class="trade-timer" data-trade-id="${tradeId}" data-expires="${expiresAt}" data-amount="${trade.fromAmount}">--:--</div>
                <div class="trade-status ${statusClass}">${statusText}</div>
              </div>
            </div>
          `;
        } else {
          return `
            <div class="trade-item">
              <div>
                <div class="trade-amount ${statusClass}">
                  ${sign} ${Number(trade.fromAmount || 0).toFixed(2)} USDT 
                  <span style="color: ${arrowColor};">${arrow}</span>
                </div>
                <div class="trade-date">${created.toLocaleDateString(dateLocale)} ${created.toLocaleTimeString(dateLocale, { hour: '2-digit', minute: '2-digit' })}</div>
              </div>
              <div class="trade-status ${statusClass}">${statusText}</div>
            </div>
          `;
        }
      }).join('');

      startActiveTradeTimers();
      
    } catch {
      const errorText = lang === 'ru' ? '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏' : 'Loading error';
      container.innerHTML = `<div class="empty-trades">${errorText}</div>`;
    }
  }

  function startActiveTradeTimers() {
    const timers = document.querySelectorAll('.trade-timer');
    
    timers.forEach(timerEl => {
      const tradeId = timerEl.dataset.tradeId;
      const expiresAt = new Date(timerEl.dataset.expires);
      const amount = parseFloat(timerEl.dataset.amount) || 0;
      
      const updateTimer = () => {
        const now = new Date();
        const remaining = Math.max(0, Math.floor((expiresAt - now) / 1000));
        
        if (remaining <= 0) {
          timerEl.textContent = '00:00';
          timerEl.style.color = 'var(--danger)';
          closeAndRefreshTrade(tradeId, amount);
          return;
        }
        
        const mins = Math.floor(remaining / 60);
        const secs = remaining % 60;
        timerEl.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        
        if (remaining <= 10) {
          timerEl.style.color = 'var(--danger)';
          timerEl.style.animation = 'pulse 0.5s infinite';
        }
        
        setTimeout(updateTimer, 1000);
      };
      
      updateTimer();
    });
  }

  async function closeAndRefreshTrade(tradeId, amount) {
    const lang = localStorage.getItem('nexo_lang') || 'en';
    
    try {
      const response = await fetch(`/api/trades/close/${tradeId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      const payload = await response.json();
      const result = payload.data?.result;
      const profit = payload.data?.profit || 0;

      if (result === 'win') {
        const msg = lang === 'ru' ? `‚úÖ –í—ã–∏–≥—Ä—ã—à! +${profit.toFixed(2)} USDT` : `‚úÖ Trade won! +${profit.toFixed(2)} USDT`;
        showTradeNotification(msg, 'win');
      } else {
        const msg = lang === 'ru' ? `‚ùå –ü—Ä–æ–∏–≥—Ä—ã—à. -${amount.toFixed(2)} USDT` : `‚ùå Trade lost. -${amount.toFixed(2)} USDT`;
        showTradeNotification(msg, 'loss');
      }

    } catch (err) {
      console.error('Close trade error:', err);
    } finally {
      await loadActiveTrades();
      await loadUserBalance();
      
      if (typeof BalanceManager !== 'undefined') {
        await BalanceManager.refresh();
      }
    }
  }

  function showTradeNotification(message, type) {
    const notif = document.createElement('div');
    notif.className = `notification ${type}`;
    notif.textContent = message;
    document.body.appendChild(notif);
    
    setTimeout(() => {
      notif.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => notif.remove(), 300);
    }, 3000);
  }

  async function executeTrade() {
    const lang = localStorage.getItem('nexo_lang') || 'en';
    const amount = parseFloat(document.getElementById('tradeAmount').value);
    const balanceStr = document.getElementById('panelAvailableUsdt').textContent;
    const balance = parseFloat(balanceStr.replace(/[^0-9.]/g, ''));
    
    const minAmountText = lang === 'ru' ? '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: 1 USDT' : 'Minimum amount: 1 USDT';
    if (isNaN(amount) || amount < 1) { alert(minAmountText); return; }
    
    if (amount > balance) {
      const alertBox = document.getElementById('balanceAlert');
      alertBox.style.display = 'block';
      setTimeout(() => alertBox.style.display = 'none', 3000);
      return;
    }

    const btn = document.getElementById('panelSubmitBtn');
    btn.disabled = true;
    btn.innerText = lang === 'ru' ? '–û—Ç–∫—Ä—ã—Ç–∏–µ...' : 'Opening...';

    const activeTimeBtn = document.querySelector('#timeSelection .time-btn.active');
    const timeText = activeTimeBtn ? activeTimeBtn.textContent : '30s';

    try {
      const response = await fetch('/api/trades/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userId,
          fromCurrency: 'USDT',
          toCurrency: coinSymbol,
          symbol: coinSymbol,
          fromAmount: amount,
          direction: currentTradeType === 'buy' ? 'up' : 'down',
          duration: timeText
        })
      });

      const payload = await response.json();
      if (!response.ok) {
        if (payload?.tradingBlocked) {
          const blockedText = lang === 'ru' ? '‚õî –¢–æ—Ä–≥–æ–≤–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞' : '‚õî Trading blocked';
          showTradeNotification(blockedText, 'loss');
        } else {
          alert(payload?.error || (lang === 'ru' ? '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Å–¥–µ–ª–∫—É' : 'Failed to open trade'));
        }
        btn.disabled = false;
        btn.innerText = lang === 'ru' ? '–û—Ç–∫—Ä—ã—Ç—å —Å–¥–µ–ª–∫—É' : 'Open Trade';
        return;
      }

      const successText = lang === 'ru' ? `üöÄ –°–¥–µ–ª–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –Ω–∞ ${timeText}!` : `üöÄ Trade opened for ${timeText}!`;
      showTradeNotification(successText, 'info');
      
      document.getElementById('tradeAmount').value = '';
      closeTrade();
      
      await loadUserBalance();
      await loadActiveTrades();

    } catch (err) {
      alert(lang === 'ru' ? '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏' : 'Network error');
    } finally {
      btn.disabled = false;
      const openText = lang === 'ru' ? '–û—Ç–∫—Ä—ã—Ç—å —Å–¥–µ–ª–∫—É' : 'Open Trade';
      btn.innerText = openText;
    }
  }

  function setTime(btn) {
    document.querySelectorAll('#timeSelection .time-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }

  function openTrade(type) {
    const lang = localStorage.getItem('nexo_lang') || 'en';
    currentTradeType = type;
    document.getElementById('tradePanel').classList.add('active');
    document.getElementById('panelOverlay').style.display = 'block';
    
    const titleEl = document.getElementById('panelTitle');
    const btn = document.getElementById('panelSubmitBtn');
    
    if (type === 'buy') {
      titleEl.innerHTML = `<span class="arrow-up">‚Üë</span> <span>${lang === 'ru' ? '–ü—Ä–æ–≥–Ω–æ–∑: –í–í–ï–†–•' : 'Predict: UP'}</span>`;
      btn.className = 'panel-submit up';
    } else {
      titleEl.innerHTML = `<span class="arrow-down">‚Üì</span> <span>${lang === 'ru' ? '–ü—Ä–æ–≥–Ω–æ–∑: –í–ù–ò–ó' : 'Predict: DOWN'}</span>`;
      btn.className = 'panel-submit down';
    }
  }

  function closeTrade() {
    document.getElementById('tradePanel').classList.remove('active');
    document.getElementById('panelOverlay').style.display = 'none';
  }

  window.addEventListener('DOMContentLoaded', () => {
    if (tg?.expand) tg.expand();
    document.getElementById('pairName').textContent = `${coinSymbol} / USDT`;
    document.getElementById('coinIcon').textContent = coinSymbol.slice(0, 2);

    initChart();
    updateLivePrice();
    setInterval(updateLivePrice, 3000);

    resolveUserId()
      .then((id) => {
        userId = id;
        return Promise.all([loadUserBalance(), loadActiveTrades()]);
      })
      .catch((e) => {
        console.error('init_error', e);
      });
  });
</script>

<!-- Bottom Navigation Bar -->
<nav class="bottom-nav">
    <a href="index.html" class="nav-item">
        <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg></span>
        <span class="nav-label" data-i18n="assets">–ê–∫—Ç–∏–≤—ã</span>
    </a>
    <a href="trading.html" class="nav-item">
        <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg></span>
        <span class="nav-label" data-i18n="markets">–†—ã–Ω–∫–∏</span>
    </a>
    <a href="exchange.html" class="nav-item">
        <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/></svg></span>
        <span class="nav-label" data-i18n="exchange">–û–±–º–µ–Ω</span>
    </a>
    <a href="terminal.html" class="nav-item active">
        <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg></span>
        <span class="nav-label" data-i18n="terminal">–¢–µ—Ä–º–∏–Ω–∞–ª</span>
    </a>
</nav>
</body>
</html>
