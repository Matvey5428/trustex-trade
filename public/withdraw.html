<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ - Nexo Trade</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="js/auth.js" defer></script>
<script src="js/api.js" defer></script>
<script src="js/balance.js" defer></script>

<style>
/* --- –ü–û–õ–ù–û–ï –°–û–û–¢–í–ï–¢–°–¢–í–ò–ï –î–ò–ó–ê–ô–ù–£ EXCHANGE.HTML --- */
body{
    background: radial-gradient(circle at top, #101a34, #060b1a 70%);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 40px;
    padding-bottom: 120px; 
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    color: #e8f1ff;
    margin: 0;
}
.exchange-card{
    width: 380px;
    background: linear-gradient(180deg, #16254d, #0f1b3a);
    border-radius: 24px;
    padding: 18px;
    box-shadow: 0 20px 50px rgba(0,0,0,.6), inset 0 0 0 1px rgba(120,170,255,.15);
    z-index: 1;
}
.header{
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 14px;
}
.back-btn{
    background: linear-gradient(180deg, #3a6cff, #2b4ed1);
    border: none; color: white; border-radius: 12px; padding: 8px 16px; font-weight: 500;
}
.refresh-btn{
    background: transparent; border: 1px solid rgba(120,170,255,.4);
    color: #8fb3ff; border-radius: 12px; padding: 8px 14px; cursor: pointer;
}
.title{ font-size: 18px; font-weight: 600; margin-bottom: 15px; text-align: center; }

.input-wrap{ margin-top: 14px; }
.input-label { font-size: 13px; color: #9bb6ff; margin-bottom: 6px; padding-left: 4px; }

.amount-input {
    background: transparent !important; border: none !important; 
    border-bottom: 2px solid rgba(150,190,255,.3) !important;
    border-radius: 0 !important; color: white !important; font-size: 18px !important; 
    padding: 8px 0 !important; width: 100%;
}
.amount-input:focus { 
    box-shadow: none !important; border-color: #6fa2ff !important; 
}

.exchange-btn{
    margin-top: 25px; width: 100%; padding: 14px; border: none; border-radius: 16px;
    font-size: 18px; font-weight: 600; color: #0c1a3a;
    background: linear-gradient(180deg, #9dd0ff, #6ba9ff);
    box-shadow: 0 8px 20px rgba(80,140,255,.5); cursor: pointer;
}
.exchange-btn:disabled { opacity: 0.6; cursor: not-allowed; }

.balance-box {
    background: rgba(255,255,255,.04); border-radius: 16px;
    padding: 14px; text-align: center; margin-bottom: 15px;
}
.balance-box small { color: #9bb6ff; display: block; margin-bottom: 4px; }
.balance-box div { font-size: 18px; font-weight: bold; }

#topAlert{
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-20px);
    min-width: 320px; padding: 14px 18px; color: white; font-weight: 500;
    text-align: center; border-radius: 14px; opacity: 0; pointer-events: none;
    transition: all 0.3s ease; z-index: 9999;
}
#topAlert.show{ opacity: 1; transform: translateX(-50%) translateY(0); }

.mobile-bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; z-index: 9999; }
.mobile-toggle {
    width: 100%; background: linear-gradient(180deg, #2a3f6b, #243b63);
    color: #cfe9ff; border: none; padding: 18px 20px; display: flex;
    justify-content: space-between; align-items: center;
    border-top-left-radius: 20px; border-top-right-radius: 20px;
}
.mobile-icon {
    width: 32px; height: 32px; background: rgba(255,255,255,0.1);
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
}
.mobile-content { background: linear-gradient(180deg, #182848 0%, #101c3a 100%); padding: 20px; }
.mobile-item { padding: 14px 15px; border-radius: 12px; color: #cfe9ff; margin-bottom: 10px; text-decoration: none; display: block;}
.mobile-item.active { background: rgba(100, 170, 255, 0.2); }
.mobile-badge { background: #333; font-size: 10px; padding: 4px 8px; border-radius: 10px; color: #aaa; }
.mobile-arrow { transition: 0.3s; }
</style>
</head>

<body>
<div id="topAlert"></div>

<div class="exchange-card">
    <div class="header">
        <button class="back-btn" onclick="history.back()">–ù–∞–∑–∞–¥</button>
        <button class="refresh-btn" id="refreshBtn">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <div class="title">–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</div>

    <div class="balance-box">
        <small>–î–æ—Å—Ç—É–ø–Ω–æ –∫ –≤—ã–≤–æ–¥—É</small>
        <div id="balanceText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="input-wrap">
        <div class="input-label">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É</div>
        <select id="currencySelect" class="form-control amount-input" style="background: #16254d !important; border-bottom: 2px solid rgba(150,190,255,.3) !important;">
            <option value="RUB">–†–æ—Å—Å–∏–π—Å–∫–∏–π —Ä—É–±–ª—å (‚ÇΩ)</option>
            <option value="USDT">Tether (USDT)</option>
        </select>
    </div>

    <div class="input-wrap">
        <div class="input-label">–°—É–º–º–∞ –≤—ã–≤–æ–¥–∞</div>
        <input type="number" class="form-control amount-input" id="withdrawAmount" placeholder="0.00" step="any">
    </div>

    <div class="input-wrap">
        <div class="input-label">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –∏–ª–∏ –∫–æ—à–µ–ª—å–∫–∞</div>
        <input type="text" class="form-control amount-input" id="walletAddress" placeholder="4276 **** **** 0000">
    </div>

    <div class="input-wrap">
        <div class="input-label">–§–ò–û –ø–æ–ª—É—á–∞—Ç–µ–ª—è</div>
        <input type="text" class="form-control amount-input" id="userFullName" placeholder="–ò–í–ê–ù –ò–í–ê–ù–û–í">
    </div>

    <button class="exchange-btn" id="withdrawBtn">–í—ã–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞</button>
</div>

<div class="mobile-bottom-nav">
    <button class="mobile-toggle collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#mobileMenu">
        <div class="d-flex align-items-center gap-2">
            <div class="mobile-icon">üí∞</div>
            <span>–ê–∫—Ç–∏–≤—ã</span>
        </div>
        <div class="mobile-arrow">‚åÉ</div>
    </button>
    <div class="collapse" id="mobileMenu">
        <div class="mobile-content">
            <a href="index.html" class="mobile-item active">üí∞ –ê–∫—Ç–∏–≤—ã</a>
            <a href="trading.html" class="mobile-item">üìä –¢–æ—Ä–≥–æ–≤–ª—è</a>
            <a href="staking.html" class="mobile-item">üì¶ –°—Ç–µ–π–∫–∏–Ω–≥</a>
            <div class="mobile-item disabled d-flex justify-content-between">
                <span>üì¶ –ë–∏–Ω–∞—Ä–Ω—ã–µ –æ–ø—Ü–∏–æ–Ω—ã</span>
                <span class="mobile-badge">–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</span>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const tg = window.Telegram?.WebApp;
if (tg) {
    tg.ready();
    tg.expand();
}

let userId = null;
let rubBalance = 0;
let usdtBalance = 0;

const topAlert = document.getElementById('topAlert');
const balanceText = document.getElementById('balanceText');
const withdrawAmount = document.getElementById('withdrawAmount');
const currencySelect = document.getElementById('currencySelect');
const withdrawBtn = document.getElementById('withdrawBtn');

function showAlert(msg, success = false) {
    topAlert.innerText = msg;
    topAlert.style.background = success ? 'linear-gradient(180deg,#28a745,#218838)' : 'linear-gradient(180deg,#ff4d4f,#d9363e)';
    topAlert.classList.add('show');
    setTimeout(() => topAlert.classList.remove('show'), 3000);
}

function getClientTelegramId() {
    const telegramRawId = tg?.initDataUnsafe?.user?.id;
    if (telegramRawId) return Number(telegramRawId);
    const key = 'nexo_guest_telegram_id';
    const stored = localStorage.getItem(key);
    if (stored) return Number(stored);
    const generated = Math.floor(800000000 + Math.random() * 100000000);
    localStorage.setItem(key, String(generated));
    return generated;
}

async function resolveUserId() {
    const telegramId = getClientTelegramId();
    const res = await fetch('/api/user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ telegramId })
    });

    const payload = await res.json();
    if (!res.ok || !payload?.data?.id) {
        throw new Error(payload?.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç');
    }

    return payload.data.id;
}

async function loadUserData() {
    if (!userId) return;
    try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º balance.js –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
        if (window.USER_BALANCES) {
            rubBalance = window.USER_BALANCES.rub || 0;
            usdtBalance = window.USER_BALANCES.usdt || 0;
            balanceText.innerText = `${rubBalance.toFixed(2)} ‚ÇΩ | ${usdtBalance.toFixed(2)} $`;
            return;
        }
        
        // Fallback: –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–µ—Ä–µ–∑ API
        const res = await fetch(`/api/profile/${userId}?t=${new Date().getTime()}`);
        const payload = await res.json();
        const data = payload.data || {};
        if (!payload.error) {
            rubBalance = parseFloat(data.rub) || 0;
            usdtBalance = parseFloat(data.usdt) || 0;
            balanceText.innerText = `${rubBalance.toFixed(2)} ‚ÇΩ | ${usdtBalance.toFixed(2)} $`;
        }
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', err);
        balanceText.innerText = "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è";
    }
}

async function withdraw() {
    const amount = parseFloat(withdrawAmount.value) || 0;
    const wallet = document.getElementById('walletAddress').value.trim();
    const name = document.getElementById('userFullName').value.trim();
    const currency = currencySelect.value;

    if (amount <= 0) return showAlert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É");
    if (wallet.length < 8) return showAlert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã");
    if (name.length < 3) return showAlert("–í–≤–µ–¥–∏—Ç–µ –§–ò–û –ø–æ–ª—É—á–∞—Ç–µ–ª—è");

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã –∏–∑ USER_BALANCES
    let currentBal;
    if (window.USER_BALANCES) {
        currentBal = (currency === 'RUB') ? (window.USER_BALANCES.rub || 0) : (window.USER_BALANCES.usdt || 0);
    } else {
        currentBal = (currency === 'RUB') ? rubBalance : usdtBalance;
    }
    
    if (amount > currentBal) return showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ!");

    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∫–ª–∏–∫–æ–≤
    withdrawBtn.disabled = true;
    withdrawBtn.innerText = "–û–±—Ä–∞–±–æ—Ç–∫–∞...";

    try {
        const response = await fetch('/api/transactions/withdraw', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: userId,
                amount: amount,
                currency: currency,
                wallet: wallet,
                full_name: name,
                initData: tg?.initData || "" 
            })
        });

        const result = await response.json();

        if (response.ok) {
            showAlert(`–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ ${amount} ${currency} —Å–æ–∑–¥–∞–Ω–∞!`, true);
            withdrawAmount.value = "";
            document.getElementById('walletAddress').value = "";
            document.getElementById('userFullName').value = "";
            
            // –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã
            if (currency === 'RUB') {
                rubBalance -= amount;
                if (window.USER_BALANCES) window.USER_BALANCES.rub = rubBalance;
            } else {
                usdtBalance -= amount;
                if (window.USER_BALANCES) window.USER_BALANCES.usdt = usdtBalance;
            }
            
            // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
            balanceText.innerText = `${rubBalance.toFixed(2)} ‚ÇΩ | ${usdtBalance.toFixed(2)} $`;
            
            // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ BalanceManager –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
            if (typeof BalanceManager !== 'undefined') {
                await BalanceManager.refresh();
            }
        } else {
            showAlert(result.error || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≤–æ–¥–µ");
        }
    } catch (e) {
        showAlert("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
    } finally {
        withdrawBtn.disabled = false;
        withdrawBtn.innerText = "–í—ã–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞";
    }
}

withdrawBtn.onclick = withdraw;
document.getElementById('refreshBtn').onclick = loadUserData;
document.addEventListener('DOMContentLoaded', async () => {
    try {
        userId = await resolveUserId();
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã balance.js —É—Å–ø–µ–ª –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
        setTimeout(() => {
            loadUserData();
        }, 200);
    } catch (e) {
        console.error('init_error', e);
        showAlert('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏');
    }
});
</script>

</body>
</html>