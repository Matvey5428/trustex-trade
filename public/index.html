<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TrustEx</title>
  
  <!-- Prevent flash during language load -->
  <style>body { opacity: 0; } body.i18n-ready { opacity: 1; transition: opacity 0.15s ease-out; }</style>
  <script>
    // Apply language immediately to prevent flash
    (function() {
      var lang = localStorage.getItem('nexo_lang') || 'ru';
      document.documentElement.lang = lang;
      // Fallback: show body after 500ms if i18n fails
      setTimeout(function() { document.body && document.body.classList.add('i18n-ready'); }, 500);
    })();
    // Disable zoom gestures
    document.addEventListener('gesturestart', function(e) { e.preventDefault(); });
    document.addEventListener('gesturechange', function(e) { e.preventDefault(); });
    document.addEventListener('gestureend', function(e) { e.preventDefault(); });
    document.addEventListener('touchstart', function(e) { if(e.touches.length > 1) e.preventDefault(); }, { passive: false });
  </script>
  
  <!-- Telegram Web App SDK - REQUIRED for Mini App -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-card: #1c2128;
      --bg-hover: #262c36;
      --accent: #00d4aa;
      --accent-hover: #00eebb;
      --text-primary: #f0f6fc;
      --text-secondary: #8b949e;
      --text-muted: #6e7681;
      --border: #30363d;
      --success: #3fb950;
      --danger: #f85149;
      --warning: #d29922;
    }

    * {
      box-sizing: border-box;
    }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 0 0 80px 0;
      min-height: 100vh;
      touch-action: pan-x pan-y;
      -ms-touch-action: pan-x pan-y;
    }

    html {
      touch-action: pan-x pan-y;
      -ms-touch-action: pan-x pan-y;
    }

    .app-container {
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      padding: 0 16px;
    }

    /* Header */
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
      margin-bottom: 8px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent) 0%, #00a896 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      color: #0d1117;
    }

    .logo-text {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .logo-text span {
      color: var(--accent);
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .header-btn {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .header-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    /* Cards */
    .card-custom, .profile-box, .section-card {
      background: var(--bg-card) !important;
      border: 1px solid var(--border) !important;
      border-radius: 16px !important;
      padding: 20px !important;
      margin-bottom: 16px !important;
      box-shadow: none !important;
    }

    /* Balance Card */
    .balance-card {
      background: linear-gradient(135deg, #1a2332 0%, #0d1117 100%);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 16px;
    }

    .balance-label {
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .balance { 
      font-size: 36px; 
      font-weight: 700; 
      color: var(--text-primary);
      letter-spacing: -0.5px;
    }

    .balance-change {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 13px;
      font-weight: 500;
      color: var(--success);
      margin-left: 8px;
    }

    .action-wrapper {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin-top: 24px;
    }

    .action-item {
      flex: 1;
      text-align: center;
    }

    .action-box {
      width: 100%;
      height: 52px;
      border-radius: 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-primary);
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .action-box:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: #0d1117;
    }

    .action-item .label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 8px;
    }

    /* Assets */
    .asset-item {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .asset-item:hover {
      background: var(--bg-hover);
      border-color: var(--accent);
    }

    .asset-item:last-child {
      margin-bottom: 0;
    }

    .section-title {
      color: var(--text-primary);
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title::after {
      display: none;
    }

    .small-text { color: var(--text-secondary); font-size: 13px; }

    .coin {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }

    .gold { background: linear-gradient(135deg, #ffd93d 0%, #f0a500 100%); color: #000; }
    .btc { background: linear-gradient(135deg, #f7931a 0%, #e2750a 100%); color: #fff; }
    .ton { background: linear-gradient(135deg, #0098ea 0%, #0079c2 100%); color: #fff; }
    .eth { background: linear-gradient(135deg, #627eea 0%, #4c63c0 100%); color: #fff; }
    .usdt { background: linear-gradient(135deg, #26a17b 0%, #1a8a68 100%); color: #fff; }

    .asset-name {
      font-weight: 500;
      font-size: 15px;
      color: var(--text-primary);
    }

    .asset-price {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .asset-right {
      text-align: right;
      font-weight: 600;
      font-size: 15px;
      color: var(--text-primary);
    }

    /* Profile Section */
    .profile-box h6 {
      color: var(--text-primary);
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 16px;
    }

    .profile-stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .profile-stat:last-child {
      border-bottom: none;
    }

    .profile-stat-label {
      color: var(--text-secondary);
      font-size: 13px;
    }

    .profile-stat-value {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
    }

    /* History */
    .history-item {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }

    .history-item:hover {
      border-color: var(--accent);
    }

    .history-icon {
      width: 42px;
      height: 42px;
      background: var(--bg-card);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      margin-right: 12px;
    }

    .history-info { flex-grow: 1; }
    .history-type { font-weight: 500; font-size: 14px; margin-bottom: 2px; color: var(--text-primary); }
    .history-date { font-size: 12px; color: var(--text-muted); }
    
    .history-amount { text-align: right; }
    .amount-val { font-weight: 600; font-size: 15px; }
    .amount-cur { font-size: 11px; color: var(--text-muted); text-transform: uppercase; }

    .text-plus { color: var(--success); }
    .text-minus { color: var(--danger); }

    /* Reviews Section */
    .reviews-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .section-subtitle {
      color: var(--text-secondary);
      font-size: 13px;
      margin-top: 4px;
    }

    .nav-btn {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.2s;
      cursor: pointer;
    }

    .nav-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .review-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin: 16px 0;
      display: none;
    }

    .review-card.active { display: block; animation: fadeIn 0.3s; }
    .stars { color: var(--accent); font-size: 16px; margin-top: 8px; }
    
    .all-reviews-btn {
      background: var(--accent);
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      color: #0d1117;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .all-reviews-btn:hover {
      background: var(--accent-hover);
    }

    .reviews-footer {
      color: var(--text-muted);
      font-size: 13px;
    }

    /* Analytics */
    .analytics-btn-group, .history-btn-group {
      display: flex;
      gap: 8px;
      flex-wrap: nowrap;
      margin-bottom: 16px;
      overflow-x: auto;
      scrollbar-width: none;
    }

    .analytics-btn-group::-webkit-scrollbar,
    .history-btn-group::-webkit-scrollbar { display: none; }    

    .btn-period, .btn-filter {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
      white-space: nowrap;
      flex: 1;
      text-align: center;
      cursor: pointer;
    }

    .btn-period:hover, .btn-filter:hover {
      border-color: var(--accent);
      color: var(--text-primary);
    }

    .btn-period.active, .btn-filter.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #0d1117;
    }
    
    .stat-box {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .stat-label { color: var(--text-secondary); font-size: 13px; }
    .stat-value { font-size: 16px; font-weight: 600; color: var(--text-primary); }
    .text-success-custom { color: var(--success); }
    .text-danger-custom { color: var(--danger); }

    .stat-period-box {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .period-name { 
      font-size: 15px; 
      font-weight: 600; 
      color: var(--accent); 
      margin-bottom: 12px; 
    }

    .period-row { 
      display: flex; 
      justify-content: space-between; 
      margin-bottom: 8px; 
    }

    .period-row:last-child {
      margin-bottom: 0;
    }

    .period-label { color: var(--text-secondary); font-size: 13px; }
    .period-value { font-weight: 600; font-size: 14px; color: var(--text-primary); }
    .period-value small { color: var(--text-muted); font-weight: normal; margin-left: 5px; font-size: 12px; }

    /* Bottom Navigation Bar */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 9999;
      background: linear-gradient(180deg, #161b22 0%, #0d1117 100%);
      border-top: 1px solid rgba(48, 54, 61, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 12px 0 max(16px, env(safe-area-inset-bottom));
      display: flex;
      justify-content: space-around;
      align-items: center;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      color: #6e7681;
      padding: 8px 0;
      border-radius: 12px;
      transition: color 0.15s ease;
      flex: 1;
      position: relative;
      -webkit-tap-highlight-color: transparent;
    }

    .nav-item:hover {
      color: #8b949e;
    }

    .nav-item.active {
      color: var(--accent);
    }

    .nav-item::before {
      content: '';
      position: absolute;
      top: -6px;
      left: 50%;
      transform: translateX(-50%);
      width: 20px;
      height: 2px;
      background: var(--accent);
      border-radius: 2px;
      opacity: 0;
      transition: opacity 0.15s ease;
    }

    .nav-item.active::before {
      opacity: 1;
    }

    .nav-icon {
      width: 24px;
      height: 24px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-icon svg {
      width: 22px;
      height: 22px;
      fill: currentColor;
    }

    .nav-label {
      font-size: 10px;
      font-weight: 500;
      letter-spacing: 0.1px;
    }

    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(8px); } 
      to { opacity: 1; transform: translateY(0); } 
    }

    @media (max-width: 380px) {
      .btn-period, .btn-filter { font-size: 11px; padding: 6px 8px; }
      .history-btn-group { gap: 4px; }
      .action-wrapper { gap: 8px; }
      .action-box { height: 48px; font-size: 16px; }
      .action-item .label { font-size: 11px; }
    }
    
    /* Support FAB */
    .support-fab {
      position: fixed;
      bottom: 90px;
      right: 16px;
      width: 52px;
      height: 52px;
      border-radius: 14px;
      background: var(--accent);
      border: none;
      box-shadow: 0 4px 16px rgba(0, 212, 170, 0.3);
      cursor: pointer;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      transition: all 0.2s;
    }
    
    .support-fab:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 212, 170, 0.4);
    }
    
    .support-fab:active {
      transform: translateY(0);
    }
    
    .support-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: var(--danger);
      color: #fff;
      font-size: 10px;
      font-weight: 600;
      min-width: 18px;
      height: 18px;
      border-radius: 9px;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0 5px;
    }

    /* Chart Placeholder */
    #pnlChartPlaceholder {
      color: var(--text-muted);
      font-size: 13px;
    }

    /* Price Ticker */
    .price-ticker {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      overflow: hidden;
      padding: 10px 0;
      margin: 0 -16px 16px -16px;
    }

    .ticker-track {
      display: flex;
      gap: 32px;
      animation: tickerScroll 20s linear infinite;
      width: max-content;
    }

    .ticker-track:hover {
      animation-play-state: paused;
    }

    @keyframes tickerScroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }

    .ticker-item {
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
      font-size: 13px;
    }

    .ticker-symbol {
      font-weight: 600;
      color: var(--text-primary);
    }

    .ticker-price {
      color: var(--text-secondary);
    }

    .ticker-change {
      font-weight: 500;
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .ticker-change.up {
      color: var(--success);
      background: rgba(63, 185, 80, 0.15);
    }

    .ticker-change.down {
      color: var(--danger);
      background: rgba(248, 81, 73, 0.15);
    }

    /* Settings Panel */
    .settings-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .settings-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 0;
      border-bottom: 1px solid var(--border);
    }

    .settings-item:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .settings-item:first-child {
      padding-top: 0;
    }

    .settings-label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: var(--text-primary);
    }

    .settings-label .icon {
      font-size: 18px;
    }

    .settings-value {
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 48px;
      height: 26px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--bg-hover);
      border: 1px solid var(--border);
      border-radius: 26px;
      transition: 0.3s;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 2px;
      bottom: 2px;
      background-color: var(--text-muted);
      border-radius: 50%;
      transition: 0.3s;
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--accent);
      border-color: var(--accent);
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(22px);
      background-color: #0d1117;
    }

    /* Language Select */
    .lang-select {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      color: var(--text-primary);
      font-size: 13px;
      cursor: pointer;
      outline: none;
      transition: all 0.2s;
    }

    .lang-select:hover {
      border-color: var(--accent);
    }

    .lang-select:focus {
      border-color: var(--accent);
    }

    .version-tag {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
    }
    
    /* Skeleton Loading */
    .skeleton {
      background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-hover) 50%, var(--bg-secondary) 75%);
      background-size: 200% 100%;
      animation: skeleton-pulse 1.5s ease-in-out infinite;
      border-radius: 6px;
      color: transparent !important;
    }
    
    @keyframes skeleton-pulse {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .balance.loaded {
      animation: balance-appear 0.3s ease-out;
    }
    
    @keyframes balance-appear {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    
    .asset-right.loaded {
      animation: balance-appear 0.2s ease-out;
    }
  </style>
</head>
<body>

<!-- Floating Support Button -->
<button class="support-fab" onclick="window.location.href='support.html'">
  üí¨
  <span class="support-badge" id="supportBadge"></span>
</button>

<div class="app-container">

    <!-- Header -->
    <div class="app-header">
      <div class="logo">
        <div class="logo-icon">T</div>
        <div class="logo-text">Trust<span>Ex</span></div>
      </div>
      <div class="header-actions">
        <button class="header-btn" onclick="window.location.href='trading.html'" title="–¢–æ—Ä–≥–æ–≤–ª—è">üìä</button>
      </div>
    </div>

    <!-- Price Ticker -->
    <div class="price-ticker">
      <div class="ticker-track" id="tickerTrack">
        <div class="ticker-item">
          <span class="ticker-symbol">BTC</span>
          <span class="ticker-price" id="tickerBtcPrice">$0.00</span>
          <span class="ticker-change up" id="tickerBtcChange">+0.00%</span>
        </div>
        <div class="ticker-item">
          <span class="ticker-symbol">ETH</span>
          <span class="ticker-price" id="tickerEthPrice">$0.00</span>
          <span class="ticker-change up" id="tickerEthChange">+0.00%</span>
        </div>
        <div class="ticker-item">
          <span class="ticker-symbol">TON</span>
          <span class="ticker-price" id="tickerTonPrice">$0.00</span>
          <span class="ticker-change up" id="tickerTonChange">+0.00%</span>
        </div>
        <div class="ticker-item">
          <span class="ticker-symbol">SOL</span>
          <span class="ticker-price" id="tickerSolPrice">$0.00</span>
          <span class="ticker-change up" id="tickerSolChange">+0.00%</span>
        </div>
        <div class="ticker-item">
          <span class="ticker-symbol">XRP</span>
          <span class="ticker-price" id="tickerXrpPrice">$0.00</span>
          <span class="ticker-change up" id="tickerXrpChange">+0.00%</span>
        </div>
        <!-- Duplicate for seamless loop -->
        <div class="ticker-item">
          <span class="ticker-symbol">BTC</span>
          <span class="ticker-price" id="tickerBtcPrice2">$0.00</span>
          <span class="ticker-change up" id="tickerBtcChange2">+0.00%</span>
        </div>
        <div class="ticker-item">
          <span class="ticker-symbol">ETH</span>
          <span class="ticker-price" id="tickerEthPrice2">$0.00</span>
          <span class="ticker-change up" id="tickerEthChange2">+0.00%</span>
        </div>
        <div class="ticker-item">
          <span class="ticker-symbol">TON</span>
          <span class="ticker-price" id="tickerTonPrice2">$0.00</span>
          <span class="ticker-change up" id="tickerTonChange2">+0.00%</span>
        </div>
        <div class="ticker-item">
          <span class="ticker-symbol">SOL</span>
          <span class="ticker-price" id="tickerSolPrice2">$0.00</span>
          <span class="ticker-change up" id="tickerSolChange2">+0.00%</span>
        </div>
        <div class="ticker-item">
          <span class="ticker-symbol">XRP</span>
          <span class="ticker-price" id="tickerXrpPrice2">$0.00</span>
          <span class="ticker-change up" id="tickerXrpChange2">+0.00%</span>
        </div>
      </div>
    </div>

    <!-- Balance Card -->
    <div class="balance-card">
      <div class="balance-label">
        <span>üíé</span> <span data-i18n="totalBalance">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</span>
      </div>
      <div class="balance skeleton" id="totalBalance">$0000.00</div>
      <div class="action-wrapper">      
        <div class="action-item">
          <button class="action-box" onclick="window.location.href='deposit.html'">‚Üë</button>
          <div class="label" data-i18n="deposit">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</div>
        </div>
        <div class="action-item">
          <button class="action-box" onclick="window.location.href='withdraw.html'">‚Üì</button>
          <div class="label" data-i18n="withdraw">–í—ã–≤–µ—Å—Ç–∏</div>
        </div>
        <div class="action-item">
          <button class="action-box" onclick="window.location.href='exchange.html'">‚áÑ</button>
          <div class="label" data-i18n="exchange">–û–±–º–µ–Ω—è—Ç—å</div>
        </div>
      </div>
    </div>

    <!-- Profile -->
    <div class="section-card">
      <h5 class="section-title">üë§ <span data-i18n="profile">–ü—Ä–æ—Ñ–∏–ª—å</span></h5>
      <div class="profile-stat">
        <span class="profile-stat-label" data-i18n="accountId">ID –∞–∫–∫–∞—É–Ω—Ç–∞</span>
        <span class="profile-stat-value" id="userIdDisplay">0</span>
      </div>
      <div class="profile-stat">
        <span class="profile-stat-label" data-i18n="statsLabel">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–≤—Å–µ–≥–æ / –ø–æ–±–µ–¥ / –ø—Ä–æ–∏–≥—Ä—ã—à–µ–π)</span>
        <span class="profile-stat-value" id="stats">0 / <span style="color: var(--success)">0</span> / <span style="color: var(--danger)">0</span></span>
      </div>
      <div class="profile-stat">
        <span class="profile-stat-label" data-i18n="tradingVolume">–û–±—ä–µ–º —Ç–æ—Ä–≥–æ–≤</span>
        <span class="profile-stat-value" id="tradingVolume">0.00 USDT</span>
      </div>
      <div class="profile-stat">
        <span class="profile-stat-label" data-i18n="verification">–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è</span>
        <span class="profile-stat-value" style="color: var(--warning)" id="verification">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>
      </div>
    </div>

    <!-- Settings -->
    <div class="settings-card">
      <div class="settings-item">
        <div class="settings-label">
          <span class="icon">üîî</span>
          <span data-i18n="notifications">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="notificationsToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="settings-item">
        <div class="settings-label">
          <span class="icon">üåê</span>
          <span data-i18n="language">–Ø–∑—ã–∫</span>
        </div>
        <select class="lang-select" id="languageSelect">
          <option value="ru" selected>üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
          <option value="en">üá¨üáß English</option>
        </select>
      </div>
      <div class="settings-item">
        <div class="settings-label">
          <span class="icon">‚ÑπÔ∏è</span>
          <span data-i18n="version">–í–µ—Ä—Å–∏—è</span>
        </div>
        <span class="version-tag">v1.0.0</span>
      </div>
    </div>

    <!-- Fiat -->
    <div class="section-card">
      <h5 class="section-title">üí∞ <span data-i18n="fiatAccounts">–í–∞–ª—é—Ç–Ω—ã–µ —Å—á–µ—Ç–∞</span></h5>
      <div class="asset-item">
        <div class="asset-left d-flex align-items-center gap-3">
          <div class="coin gold">‚ÇΩ</div>
          <div><div class="asset-name" data-i18n="rub">–†–æ—Å—Å–∏–π—Å–∫–∏–π —Ä—É–±–ª—å</div><div class="asset-price" id="rubPrice">... ‚ÇΩ</div></div>
        </div>
        <div class="asset-right skeleton" id="rubBalance">0000.00 ‚ÇΩ</div>
      </div>
    </div>

    <!-- Crypto -->
    <div class="section-card">
      <h5 class="section-title">ü™ô <span data-i18n="crypto">–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã</span></h5>
      <div class="asset-item">
        <div class="asset-left d-flex align-items-center gap-3"><div class="coin btc">‚Çø</div><div><div class="asset-name">Bitcoin</div><div class="asset-price" id="btcPrice">... $</div></div></div>
        <div class="asset-right skeleton" id="btcBalance">0.0000 $</div>
      </div>
      <div class="asset-item">
        <div class="asset-left d-flex align-items-center gap-3"><div class="coin ton">T</div><div><div class="asset-name">Toncoin</div><div class="asset-price" id="tonPrice">... $</div></div></div>
        <div class="asset-right skeleton" id="tonBalance">0.0000 $</div>
      </div>
      <div class="asset-item">
        <div class="asset-left d-flex align-items-center gap-3"><div class="coin eth">‚óÜ</div><div><div class="asset-name">Ethereum</div><div class="asset-price" id="ethPrice">... $</div></div></div>
        <div class="asset-right skeleton" id="ethBalance">0.0000 $</div>
      </div>
      <div class="asset-item">
        <div class="asset-left d-flex align-items-center gap-3"><div class="coin usdt">‚ÇÆ</div><div><div class="asset-name">Tether</div><div class="asset-price" id="usdtPrice">1.00 $</div></div></div>
        <div class="asset-right skeleton" id="usdtBalance">0.00 $</div>
      </div>
    </div>

    <!-- Reviews -->
    <div class="reviews-section">
      <h5 class="section-title">‚≠ê <span data-i18n="reviews">–û—Ç–∑—ã–≤—ã –∫–ª–∏–µ–Ω—Ç–æ–≤</span></h5>
      <div class="section-subtitle" data-i18n="reviewsSubtitle">–ß—Ç–æ –≥–æ–≤–æ—Ä—è—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ</div>
      <div class="d-flex gap-2 mt-3">
        <button class="nav-btn" id="prevReview">‚Üê</button>
        <button class="nav-btn" id="nextReview">‚Üí</button>
      </div>
      <div id="reviewsContainer"></div>
      <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="reviews-footer" id="reviewCounter">–û—Ç–∑—ã–≤—ã 1 –∏–∑ 36</div>
        <button class="all-reviews-btn" onclick="window.location.href='reviews.html'" data-i18n="allReviews">–í—Å–µ –æ—Ç–∑—ã–≤—ã</button>
      </div>
    </div>

    <!-- Analytics -->
    <div class="section-card">
        <h5 class="section-title">üìà <span data-i18n="analytics">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏</span></h5>
        <div class="analytics-btn-group">
            <button class="btn-period active" onclick="selectPeriod(this, 'all')" data-i18n="allTime">–í—Å–µ</button>
            <button class="btn-period" onclick="selectPeriod(this, 'year')" data-i18n="year">–ì–æ–¥</button>
            <button class="btn-period" onclick="selectPeriod(this, 'month')" data-i18n="month">–ú–µ—Å—è—Ü</button>
            <button class="btn-period" onclick="selectPeriod(this, 'week')" data-i18n="week">–ù–µ–¥–µ–ª—è</button>
            <button class="btn-period" onclick="selectPeriod(this, 'day')" data-i18n="day">–î–µ–Ω—å</button>
        </div>
        <div class="stat-box"><div class="stat-label" data-i18n="winRate">Win Rate</div><div class="stat-value" id="winRate">0.0%</div></div>
        <div class="stat-box"><div class="stat-label" data-i18n="avgProfit">–°—Ä–µ–¥–Ω—è—è –ø—Ä–∏–±—ã–ª—å</div><div class="stat-value text-success-custom" id="avgProfit">+0.00 USDT</div></div>
        <div class="stat-box"><div class="stat-label" data-i18n="avgLoss">–°—Ä–µ–¥–Ω–∏–π —É–±—ã—Ç–æ–∫</div><div class="stat-value text-danger-custom" id="avgLoss">0.00 USDT</div></div>
        <div class="stat-box"><div class="stat-label" data-i18n="maxWin">–ú–∞–∫—Å. –≤—ã–∏–≥—Ä—ã—à</div><div class="stat-value text-success-custom" id="maxWin">+0.00 USDT</div></div>
        <div class="stat-box"><div class="stat-label" data-i18n="maxLoss">–ú–∞–∫—Å. –ø—Ä–æ–∏–≥—Ä—ã—à</div><div class="stat-value text-danger-custom" id="maxLoss">0.00 USDT</div></div>
        <div class="stat-box"><div class="stat-label" data-i18n="profitFactor">Profit Factor</div><div class="stat-value" id="profitFactor">0.00</div></div>
    </div>

    <!-- P&L Chart -->
    <div class="section-card">
        <h5 class="section-title">üìä <span data-i18n="pnlChart">–ì—Ä–∞—Ñ–∏–∫ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ (P&L)</span></h5>
        <div id="pnlChartContainer" style="height: 220px; position: relative;">
            <canvas id="pnlChart"></canvas>
            <div id="pnlChartPlaceholder" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center;">
                <span data-i18n="noData">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö</span>
            </div>
        </div>
    </div>

    <!-- Period Stats -->
    <div class="section-card">
        <h5 class="section-title">üìÖ <span data-i18n="periodStats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º</span></h5>
        <div class="stat-period-box">
            <div class="period-name" data-i18n="today">–°–µ–≥–æ–¥–Ω—è</div>
            <div class="period-row"><span class="period-label" data-i18n="profit">–ü—Ä–∏–±—ã–ª—å</span><span class="period-value text-success-custom" id="pProfitToday">+0.00 USDT</span></div>
            <div class="period-row"><span class="period-label" data-i18n="trades">–°–¥–µ–ª–æ–∫</span><span class="period-value" id="pTradesToday">0 <small>(0W / 0L)</small></span></div>
        </div>
        <div class="stat-period-box">
            <div class="period-name" data-i18n="week">–ù–µ–¥–µ–ª—è</div>
            <div class="period-row"><span class="period-label" data-i18n="profit">–ü—Ä–∏–±—ã–ª—å</span><span class="period-value text-success-custom" id="pProfitWeek">+0.00 USDT</span></div>
            <div class="period-row"><span class="period-label" data-i18n="trades">–°–¥–µ–ª–æ–∫</span><span class="period-value" id="pTradesWeek">0 <small>(0W / 0L)</small></span></div>
        </div>
        <div class="stat-period-box">
            <div class="period-name" data-i18n="month">–ú–µ—Å—è—Ü</div>
            <div class="period-row"><span class="period-label" data-i18n="profit">–ü—Ä–∏–±—ã–ª—å</span><span class="period-value text-success-custom" id="pProfitMonth">+0.00 USDT</span></div>
            <div class="period-row"><span class="period-label" data-i18n="trades">–°–¥–µ–ª–æ–∫</span><span class="period-value" id="pTradesMonth">0 <small>(0W / 0L)</small></span></div>
        </div>
    </div>

    <!-- Transaction History -->
    <div class="section-card">
        <h5 class="section-title">üîÑ <span data-i18n="transactionHistory">–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</span></h5>
        <div class="history-btn-group">
            <button class="btn-filter active" onclick="filterHistory('all')" id="filterAll">–í—Å–µ (0)</button>
            <button class="btn-filter" onclick="filterHistory('withdraw')" id="filterWithdraw">–í—ã–≤–æ–¥—ã (0)</button>
            <button class="btn-filter" onclick="filterHistory('deposit')" id="filterDeposit">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è (0)</button>
        </div>
        <div id="historyContent" style="min-height: 120px;">
            <div style="height: 150px; display: flex; align-items: center; justify-content: center;">
                <span>–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—É—Å—Ç–∞</span>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item active">
            <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg></span>
            <span class="nav-label" data-i18n="assets">–ê–∫—Ç–∏–≤—ã</span>
        </a>
        <a href="trading.html" class="nav-item">
            <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg></span>
            <span class="nav-label" data-i18n="markets">–†—ã–Ω–∫–∏</span>
        </a>
        <a href="exchange.html" class="nav-item">
            <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/></svg></span>
            <span class="nav-label" data-i18n="exchange">–û–±–º–µ–Ω</span>
        </a>
        <a href="terminal.html" class="nav-item">
            <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg></span>
            <span class="nav-label" data-i18n="terminal">–¢–µ—Ä–º–∏–Ω–∞–ª</span>
        </a>
    </nav>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/auth.js?v=2"></script>
<script src="/js/api.js"></script>
<script src="/js/balance.js"></script>
<script>
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.ready();
    tg.expand();
  }

  let userId = null;
  let RUB_RATE = 79.10;
  let allTransactions = [];
  let currentHistoryFilter = 'all';
  let currentLang = localStorage.getItem('language') || 'ru';

  // Translations
  const i18n = {
    ru: {
      totalBalance: '–û–±—â–∏–π –±–∞–ª–∞–Ω—Å',
      deposit: '–ü–æ–ø–æ–ª–Ω–∏—Ç—å',
      withdraw: '–í—ã–≤–µ—Å—Ç–∏',
      exchange: '–û–±–º–µ–Ω—è—Ç—å',
      notifications: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',
      language: '–Ø–∑—ã–∫',
      version: '–í–µ—Ä—Å–∏—è',
      profile: '–ü—Ä–æ—Ñ–∏–ª—å',
      accountId: 'ID –∞–∫–∫–∞—É–Ω—Ç–∞',
      statsLabel: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–≤—Å–µ–≥–æ / –ø–æ–±–µ–¥ / –ø—Ä–æ–∏–≥—Ä—ã—à–µ–π)',
      tradingVolume: '–û–±—ä–µ–º —Ç–æ—Ä–≥–æ–≤',
      verification: '–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è',
      verified: '‚úÖ –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω',
      notVerified: '‚ö†Ô∏è –ù–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω',
      fiatAccounts: '–í–∞–ª—é—Ç–Ω—ã–µ —Å—á–µ—Ç–∞',
      crypto: '–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã',
      rub: '–†–æ—Å—Å–∏–π—Å–∫–∏–π —Ä—É–±–ª—å',
      reviews: '–û—Ç–∑—ã–≤—ã –∫–ª–∏–µ–Ω—Ç–æ–≤',
      reviewsSubtitle: '–ß—Ç–æ –≥–æ–≤–æ—Ä—è—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ',
      allReviews: '–í—Å–µ –æ—Ç–∑—ã–≤—ã',
      reviewsOf: '–û—Ç–∑—ã–≤—ã',
      of: '–∏–∑',
      analytics: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏',
      allTime: '–í—Å–µ',
      year: '–ì–æ–¥',
      month: '–ú–µ—Å—è—Ü',
      week: '–ù–µ–¥–µ–ª—è',
      day: '–î–µ–Ω—å',
      winRate: 'Win Rate',
      avgProfit: '–°—Ä–µ–¥–Ω—è—è –ø—Ä–∏–±—ã–ª—å',
      avgLoss: '–°—Ä–µ–¥–Ω–∏–π —É–±—ã—Ç–æ–∫',
      maxWin: '–ú–∞–∫—Å. –≤—ã–∏–≥—Ä—ã—à',
      maxLoss: '–ú–∞–∫—Å. –ø—Ä–æ–∏–≥—Ä—ã—à',
      profitFactor: 'Profit Factor',
      pnlChart: '–ì—Ä–∞—Ñ–∏–∫ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ (P&L)',
      noData: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö',
      periodStats: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º',
      today: '–°–µ–≥–æ–¥–Ω—è',
      profit: '–ü—Ä–∏–±—ã–ª—å',
      trades: '–°–¥–µ–ª–æ–∫',
      transactionHistory: '–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π',
      all: '–í—Å–µ',
      withdrawals: '–í—ã–≤–æ–¥—ã',
      deposits: '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è',
      assets: '–ê–∫—Ç–∏–≤—ã',
      markets: '–†—ã–Ω–∫–∏',
      trading: '–¢–æ—Ä–≥–æ–≤–ª—è',
      terminal: '–¢–µ—Ä–º–∏–Ω–∞–ª',
      reviews: '–û—Ç–∑—ã–≤—ã',
      binaryOptions: '–ë–∏–Ω–∞—Ä–Ω—ã–µ –æ–ø—Ü–∏–æ–Ω—ã',
      soon: '–°–∫–æ—Ä–æ'
    },
    en: {
      totalBalance: 'Total Balance',
      deposit: 'Deposit',
      withdraw: 'Withdraw',
      exchange: 'Exchange',
      notifications: 'Notifications',
      language: 'Language',
      version: 'Version',
      profile: 'Profile',
      accountId: 'Account ID',
      statsLabel: 'Statistics (total / wins / losses)',
      tradingVolume: 'Trading Volume',
      verification: 'Verification',
      verified: '‚úÖ Verified',
      notVerified: '‚ö†Ô∏è Not verified',
      fiatAccounts: 'Fiat Accounts',
      crypto: 'Cryptocurrencies',
      rub: 'Russian Ruble',
      reviews: 'Customer Reviews',
      reviewsSubtitle: 'What users say about the platform',
      allReviews: 'All Reviews',
      reviewsOf: 'Reviews',
      of: 'of',
      analytics: 'Trading Analytics',
      allTime: 'All',
      year: 'Year',
      month: 'Month',
      week: 'Week',
      day: 'Day',
      winRate: 'Win Rate',
      avgProfit: 'Average Profit',
      avgLoss: 'Average Loss',
      maxWin: 'Max Win',
      maxLoss: 'Max Loss',
      profitFactor: 'Profit Factor',
      pnlChart: 'P&L Chart',
      noData: 'Not enough data',
      periodStats: 'Period Statistics',
      today: 'Today',
      profit: 'Profit',
      trades: 'Trades',
      transactionHistory: 'Transaction History',
      all: 'All',
      withdrawals: 'Withdrawals',
      deposits: 'Deposits',
      assets: 'Assets',
      markets: 'Markets',
      trading: 'Trading',
      terminal: 'Terminal',
      reviews: 'Reviews',
      binaryOptions: 'Binary Options',
      soon: 'Soon'
    }
  };

  function t(key) {
    return i18n[currentLang][key] || i18n['ru'][key] || key;
  }

  function applyLanguage(lang) {
    currentLang = lang;
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      el.textContent = t(key);
    });
    // Update verification text based on user
    if (window.CURRENT_USER) {
      const verifEl = document.getElementById('verification');
      if (verifEl) {
        verifEl.textContent = window.CURRENT_USER.verified ? t('verified') : t('notVerified');
      }
    }
  }

  function getClientTelegramId() {
    const telegramId = TelegramAuth.getTelegramId();
    return telegramId;
  }

  async function resolveUserId() {
    try {
      const user = TelegramAuth.getCurrentUser();
      if (user) {
        return user.id;
      }
      throw new Error('User not found');
    } catch (error) {
      throw error;
    }
  }

  const updateEl = (id, val) => { 
    const el = document.getElementById(id); 
    if(el) el.textContent = val; 
  };

  async function updatePriceTicker() {
    try {
      const symbols = ["BTCUSDT", "ETHUSDT", "TONUSDT", "SOLUSDT", "XRPUSDT"];
      const [pricesRes, tickerRes] = await Promise.all([
        fetch(`https://api.binance.com/api/v3/ticker/price?symbols=${JSON.stringify(symbols)}`),
        fetch(`https://api.binance.com/api/v3/ticker/24hr?symbols=${JSON.stringify(symbols)}`)
      ]);
      
      const prices = await pricesRes.json();
      const tickers = await tickerRes.json();
      
      const tickerData = {};
      tickers.forEach(t => {
        tickerData[t.symbol] = {
          price: parseFloat(t.lastPrice),
          change: parseFloat(t.priceChangePercent)
        };
      });

      const updateTicker = (symbol, idPrice, idChange, idPrice2, idChange2) => {
        const data = tickerData[symbol + 'USDT'];
        if (!data) return;
        
        const priceStr = data.price >= 100 ? 
          `$${data.price.toLocaleString('en-US', {maximumFractionDigits: 2})}` : 
          `$${data.price.toFixed(4)}`;
        
        const changeStr = data.change >= 0 ? `+${data.change.toFixed(2)}%` : `${data.change.toFixed(2)}%`;
        const changeClass = data.change >= 0 ? 'up' : 'down';
        
        [idPrice, idPrice2].forEach(id => updateEl(id, priceStr));
        [idChange, idChange2].forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.textContent = changeStr;
            el.className = 'ticker-change ' + changeClass;
          }
        });
      };

      updateTicker('BTC', 'tickerBtcPrice', 'tickerBtcChange', 'tickerBtcPrice2', 'tickerBtcChange2');
      updateTicker('ETH', 'tickerEthPrice', 'tickerEthChange', 'tickerEthPrice2', 'tickerEthChange2');
      updateTicker('TON', 'tickerTonPrice', 'tickerTonChange', 'tickerTonPrice2', 'tickerTonChange2');
      updateTicker('SOL', 'tickerSolPrice', 'tickerSolChange', 'tickerSolPrice2', 'tickerSolChange2');
      updateTicker('XRP', 'tickerXrpPrice', 'tickerXrpChange', 'tickerXrpPrice2', 'tickerXrpChange2');
    } catch (e) {
      console.error('Ticker update error:', e);
    }
  }

  // Settings handlers
  function initSettings() {
    // Load notifications setting
    const notifToggle = document.getElementById('notificationsToggle');
    const savedNotif = localStorage.getItem('notifications');
    if (savedNotif !== null) {
      notifToggle.checked = savedNotif === 'true';
    }
    notifToggle.addEventListener('change', (e) => {
      localStorage.setItem('notifications', e.target.checked);
    });

    // Load language setting
    const langSelect = document.getElementById('languageSelect');
    const savedLang = localStorage.getItem('language') || 'ru';
    langSelect.value = savedLang;
    currentLang = savedLang;
    applyLanguage(savedLang);
    
    langSelect.addEventListener('change', (e) => {
      localStorage.setItem('language', e.target.value);
      applyLanguage(e.target.value);
    });
  }

  async function updateMarketPrices() {
    try {
        const symbols = ["BTCUSDT", "ETHUSDT", "TONUSDT"];
        const res = await fetch(`https://api.binance.com/api/v3/ticker/price?symbols=${JSON.stringify(symbols)}`);
        const prices = await res.json();
        
        const rubRes = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
        const rubData = await rubRes.json();
        RUB_RATE = rubData.rates.RUB;

        const priceMap = {};
        prices.forEach(p => priceMap[p.symbol] = parseFloat(p.price));

        updateEl('rubPrice', `${RUB_RATE.toFixed(2)} ‚ÇΩ`);
        updateEl('btcPrice', `${priceMap['BTCUSDT'].toLocaleString()} $`);
        updateEl('ethPrice', `${priceMap['ETHUSDT'].toLocaleString()} $`);
        updateEl('tonPrice', `${priceMap['TONUSDT'].toFixed(2)} $`);

        return { btc: priceMap['BTCUSDT'], eth: priceMap['ETHUSDT'], ton: priceMap['TONUSDT'] };
    } catch (e) { return null; }
  }

  async function loadUserData() {
    try {
      const user = window.CURRENT_USER;
      if (!user) {
        console.warn('No user data available');
        return;
      }

      // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π userId
      userId = user.telegram_id;

      // –ü–æ–∫–∞–∑–∞—Ç—å Telegram ID –∫–∞–∫ ID –∞–∫–∫–∞—É–Ω—Ç–∞
      const telegramId = user.telegram_id;
      updateEl('userIdDisplay', telegramId);
      
      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑ API
      try {
        const statsRes = await fetch(`/api/trades/stats/${telegramId}`);
        if (statsRes.ok) {
          const statsPayload = await statsRes.json();
          const s = statsPayload.data || {};
          document.getElementById('stats').innerHTML = `${s.total || 0} / <span style="color: #3fb950">${s.wins || 0}</span> / <span style="color: #f85149">${s.losses || 0}</span>`;
        } else {
          document.getElementById('stats').innerHTML = '0 / <span style="color: #3fb950">0</span> / <span style="color: #f85149">0</span>';
        }
      } catch (e) {
        document.getElementById('stats').innerHTML = '0 / <span style="color: #3fb950">0</span> / <span style="color: #f85149">0</span>';
      }
      
      // –û–±—ä–µ–º —Ç–æ—Ä–≥–æ–≤ (–∏–∑ –ë–î –∏–ª–∏ 0)
      const tradingVol = parseFloat(user.total_volume) || 0;
      updateEl('tradingVolume', `${tradingVol.toFixed(2)} USDT`);
      
      // –°—Ç–∞—Ç—É—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
      const verifEl = document.getElementById('verification');
      if (verifEl) {
          const isVerified = user.verified === true || user.verified === 1;
          verifEl.textContent = isVerified ? '‚úÖ –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω' : '‚ö†Ô∏è –ù–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω';
          verifEl.style.color = isVerified ? "#00ff88" : "#ffc107";
      }

      // –û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—ã –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç
      const market = await updateMarketPrices();
      
      // –ü–æ–∫–∞–∑–∞—Ç—å –æ–±—â–∏–π –±–∞–ª–∞–Ω—Å –≤ USD
      const rbcInUsd = (parseFloat(user.balance_rub) || 0) / RUB_RATE;
      const usdtBalance = parseFloat(user.balance_usdt) || 0;
      const btcInUsd = market ? (parseFloat(user.balance_btc) || 0) * market.btc : 0;
      const totalBalanceUsd = rbcInUsd + usdtBalance + btcInUsd;
      
      updateEl('totalBalance', `$${totalBalanceUsd.toFixed(2)}`);
      
      // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
      await loadTransactionHistory();
      
      console.log('‚úÖ User data loaded:', user);
    } catch (e) {
      console.error('‚ùå Error loading user data:', e.message);
      document.getElementById('userIdDisplay').textContent = '‚ùå –û—à–∏–±–∫–∞';
    }
  }

  async function loadTransactionHistory() {
    if (!userId) return;
    try {
      const res = await fetch(`/api/transactions/history/${userId}`);
      if (res.ok) {
        const payload = await res.json();
        allTransactions = (payload.data || []).map(tx => ({
          ...tx,
          createdAt: tx.created_at
        }));
        updateFilterCounts();
        filterHistory(currentHistoryFilter);
      }
    } catch (e) {
      console.error('Error loading transaction history:', e);
    }
  }

  function selectPeriod(btn, period) {
    document.querySelectorAll('.btn-period').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    loadAnalyticsData(period);
  }

  async function loadAnalyticsData(period = 'all') {
    if (!userId) return;
    try {
        const res = await fetch(`/api/trades/analytics/${userId}?period=${period}`);
        if (!res.ok) return;
        const payload = await res.json();
        const a = payload?.data || {};

        updateEl('winRate', `${a.winRate || 0}%`);
        updateEl('avgProfit', `+${a.avgProfit || '0.00'} USDT`);
        updateEl('avgLoss', `-${a.avgLoss || '0.00'} USDT`);
        updateEl('maxWin', `+${a.maxWin || '0.00'} USDT`);
        updateEl('maxLoss', `-${a.maxLoss || '0.00'} USDT`);
        updateEl('profitFactor', a.profitFactor || '0.00');
    } catch (e) { console.error('loadAnalyticsData error:', e); }
  }

  async function loadPeriodStats() {
    if (!userId) return;
    try {
      // Load stats for each period
      const periods = ['day', 'week', 'month'];
      const periodMap = { day: 'Today', week: 'Week', month: 'Month' };
      
      for (const period of periods) {
        const res = await fetch(`/api/trades/analytics/${userId}?period=${period}`);
        if (res.ok) {
          const payload = await res.json();
          const a = payload.data || {};
          const profit = parseFloat(a.totalProfit) - parseFloat(a.totalLoss) || 0;
          const profitStr = profit >= 0 ? `+${profit.toFixed(2)}` : profit.toFixed(2);
          const profitColor = profit >= 0 ? 'text-success-custom' : 'text-danger-custom';
          
          const elProfit = document.getElementById(`pProfit${periodMap[period]}`);
          const elTrades = document.getElementById(`pTrades${periodMap[period]}`);
          
          if (elProfit) {
            elProfit.textContent = `${profitStr} USDT`;
            elProfit.className = `period-value ${profitColor}`;
          }
          if (elTrades) {
            elTrades.innerHTML = `${a.totalTrades} <small>(${a.wins}W / ${a.losses}L)</small>`;
          }
        }
      }
    } catch (e) { console.error('loadPeriodStats error:', e); }
  }

  let pnlChart = null;
  
  async function loadPnlChart() {
    if (!userId) return;
    try {
      const res = await fetch(`/api/trades/pnl-history/${userId}`);
      if (!res.ok) return;
      
      const payload = await res.json();
      const history = payload?.data?.history || [];
      
      const placeholder = document.getElementById('pnlChartPlaceholder');
      const canvas = document.getElementById('pnlChart');
      
      if (history.length < 1) {
        placeholder.style.display = 'flex';
        canvas.style.display = 'none';
        return;
      }
      
      placeholder.style.display = 'none';
      canvas.style.display = 'block';
      
      // Determine color based on final P&L
      const finalPnl = parseFloat(history[history.length - 1]?.cumulative) || 0;
      const lineColor = finalPnl >= 0 ? '#00ff88' : '#ff4d4d';
      const gradientTop = finalPnl >= 0 ? 'rgba(0, 255, 136, 0.5)' : 'rgba(255, 77, 77, 0.5)';
      const gradientBottom = finalPnl >= 0 ? 'rgba(0, 255, 136, 0.0)' : 'rgba(255, 77, 77, 0.0)';
      
      const labels = history.map(h => {
        const d = new Date(h.date);
        return `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth() + 1).padStart(2, '0')}`;
      });
      const data = history.map(h => parseFloat(h.cumulative));
      
      // Destroy existing chart if any
      if (pnlChart) {
        pnlChart.destroy();
      }
      
      const ctx = canvas.getContext('2d');
      
      // Create gradient
      const gradient = ctx.createLinearGradient(0, 0, 0, 250);
      gradient.addColorStop(0, gradientTop);
      gradient.addColorStop(1, gradientBottom);
      
      pnlChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'P&L (USDT)',
            data: data,
            borderColor: lineColor,
            backgroundColor: gradient,
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 0,
            pointHoverRadius: 6,
            pointHoverBackgroundColor: lineColor
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(22, 36, 71, 0.95)',
              titleColor: '#fff',
              bodyColor: lineColor,
              borderColor: lineColor,
              borderWidth: 1,
              padding: 12,
              displayColors: false,
              callbacks: {
                label: (ctx) => `${ctx.parsed.y >= 0 ? '+' : ''}${ctx.parsed.y.toFixed(2)} USDT`
              }
            }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.05)', drawBorder: false },
              ticks: { color: '#9fb3ff', maxTicksLimit: 6 }
            },
            y: {
              grid: { color: 'rgba(255,255,255,0.05)', drawBorder: false },
              ticks: { 
                color: '#9fb3ff',
                callback: (value) => value.toFixed(0) + ' USDT'
              }
            }
          }
        }
      });
      
    } catch (e) { console.error('loadPnlChart error:', e); }
  }

  function updateFilterCounts() {
    const counts = {
        all: allTransactions.length,
        deposit: allTransactions.filter(t => t.type === 'deposit').length,
        withdraw: allTransactions.filter(t => t.type === 'withdraw').length
    };
    const filters = document.querySelectorAll('.btn-filter');
    if(filters.length >= 3) {
        filters[0].innerText = `–í—Å–µ (${counts.all})`;
        filters[1].innerText = `–í—ã–≤–æ–¥—ã (${counts.withdraw})`;
        filters[2].innerText = `–ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è (${counts.deposit})`;
    }
  }

  function filterHistory(type) {
    currentHistoryFilter = type;
    const container = document.getElementById('historyContent');
    document.querySelectorAll('.btn-filter').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('onclick').includes(`'${type}'`));
    });

    const filtered = type === 'all' ? allTransactions : allTransactions.filter(tx => tx.type === type);
    if (filtered.length === 0) {
      container.innerHTML = '<div style="height: 150px; display: flex; align-items: center; justify-content: center;"><span>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</span></div>';
      return;
    }

    container.innerHTML = filtered.map(tx => {
      const isDep = tx.type === 'deposit';
      const created = tx.createdAt ? new Date(tx.createdAt) : null;
      const dateStr = created ? created.toLocaleDateString('ru-RU') : '';
      const timeStr = created ? created.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }) : '';
      return `
        <div class="history-item">
          <div class="history-icon">${isDep ? 'üì•' : 'üì§'}</div>
          <div class="history-info">
            <div class="history-type">${isDep ? '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ' : '–í—ã–≤–æ–¥'}</div>
            <div class="history-date">${dateStr},<br>${timeStr}</div>
          </div>
          <div class="history-amount">
            <div class="amount-val ${isDep ? 'text-plus' : 'text-minus'}">${isDep ? '+' : '-'}${parseFloat(tx.amount).toFixed(2)}</div>
            <div class="amount-cur">${tx.currency || 'RUB'}</div>
          </div>
        </div>`;
    }).join('');
  }

  const reviewsContainer = document.getElementById('reviewsContainer');
  let currentIdx = 0;
  const totalReviews = 36;

  function initReviews() {
    reviewsContainer.innerHTML = '';
    for (let i = 1; i <= totalReviews; i++) {
      const card = document.createElement('div');
      card.className = `review-card ${i === 1 ? 'active' : ''}`;
      card.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
          <div><div class="review-name fw-bold">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #${1000 + i}</div><div class="review-role">–ö–ª–∏–µ–Ω—Ç Nexo</div></div>
          <div class="review-date">18.10.2025</div>
        </div>
        <p class="mt-3 mb-2">–û—Ç–ª–∏—á–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞! –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç –±—ã—Å—Ç—Ä–æ, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ—á–µ–Ω—å —É–¥–æ–±–Ω—ã–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π.</p>
        <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>`;
      reviewsContainer.appendChild(card);
    }
  }

  function updateReview(dir) {
    const cards = document.querySelectorAll('.review-card');
    if(cards.length === 0) return;
    cards[currentIdx].classList.remove('active');
    currentIdx = (currentIdx + dir + totalReviews) % totalReviews;
    cards[currentIdx].classList.add('active');
    document.getElementById('reviewCounter').textContent = `–û—Ç–∑—ã–≤—ã ${currentIdx + 1} –∏–∑ ${totalReviews}`;
  }

  document.getElementById('nextReview').onclick = () => updateReview(1);
  document.getElementById('prevReview').onclick = () => updateReview(-1);

  async function checkUnreadSupport() {
    try {
      if (!userId) return;
      const res = await fetch(`/api/user/${userId}/support/unread`);
      const data = await res.json();
      
      const badge = document.getElementById('supportBadge');
      if (data.success && data.count > 0) {
        badge.textContent = data.count;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    } catch (e) {
      console.error('Check unread error:', e);
    }
  }

  window.addEventListener('DOMContentLoaded', async () => {
    try {
      console.log('üöÄ Initializing TrustEx...');
      
      // –û–±–Ω–æ–≤–∏—Ç—å —Ç–∏–∫–µ—Ä —Å—Ä–∞–∑—É
      updatePriceTicker();
      
      // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
      if (!TelegramAuth.isAuthenticated()) {
        console.log('üîÑ Not authenticated, logging in...');
        await TelegramAuth.login();
      } else {
        console.log('‚úÖ Already authenticated');
        window.CURRENT_USER = TelegramAuth.getCurrentUser();
        window.AUTH_TOKEN = TelegramAuth.getToken();
      }

      // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      await TelegramAuth.refreshUser();
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
      await loadUserData();
      loadAnalyticsData('all');
      loadPeriodStats();
      loadPnlChart();
      initReviews();
      initSettings();
      checkUnreadSupport();
      console.log('‚úÖ Init complete');
    } catch (e) {
      console.error('‚ùå Initialization error:', e.message);
      alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + e.message);
    }
  });

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∏–∫–µ—Ä–∞ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
  setInterval(updatePriceTicker, 10000);

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
  setInterval(() => {
    if (userId) {
      loadUserData();
      checkUnreadSupport();
    }
  }, 5000);
</script>
</body>
</html>
