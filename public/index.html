<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Nexo Trade</title>
  
  <!-- Telegram Web App SDK - REQUIRED for Mini App -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #060b1a;
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px 15px 140px 15px;
      display: flex;
      justify-content: center;
    }

    .app-container {
      width: 100%;
      max-width: 500px;
    }

    .card-custom, .profile-box, .section-card {
      background: #162447 !important;
      border: none !important;
      border-radius: 25px !important;
      padding: 25px !important;
      margin-bottom: 20px !important;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4) !important;
    }

    .balance { font-size: 32px; font-weight: bold; color: #4db8ff; }
    .action-wrapper {
      display: flex;
      justify-content: center;
      gap: 30px;
      flex-wrap: nowrap;
    }
    .action-box {
      width: 70px; height: 70px; border-radius: 18px;
      background: #2b3e75; border: none; color: white; font-size: 22px;
    }

    .asset-item {
      background: #24366e; border-radius: 15px; padding: 15px;
      margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;
    }

    .section-title {
      color: #69b7ff; margin-bottom: 20px; position: relative; font-size: 1.2rem;
    }

    .section-title::after {
      content: ""; width: 40px; height: 3px; background: #69b7ff;
      position: absolute; bottom: -6px; left: 0; border-radius: 5px;
    }

    .small-text { color: #9fb3ff; font-size: 14px; }
    .coin {
      width: 42px; height: 42px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; font-weight: bold;
    }
    .gold { background: linear-gradient(45deg,#caa84f,#f4d06f); color: #000; }
    .btc { background: #f7931a; }
    .ton { background: #2da6ff; }
    .eth { background: #888; }
    .usdt { background: #26a17b; }

    .history-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      padding: 15px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      text-align: left;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .history-icon {
      width: 48px; height: 48px;
      background: rgba(59, 130, 246, 0.15);
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; margin-right: 15px;
    }

    .history-info { flex-grow: 1; }
    .history-type { font-weight: bold; font-size: 16px; margin-bottom: 2px; }
    .history-date { font-size: 12px; color: #9fb3ff; line-height: 1.2; }
    
    .history-amount { text-align: right; }
    .amount-val { font-weight: bold; font-size: 17px; }
    .amount-cur { font-size: 12px; color: #9fb3ff; text-transform: uppercase; }

    .text-plus { color: #00ff88; }
    .text-minus { color: #ff4d4d; }

    .reviews-section {
      background: linear-gradient(180deg, #182848 0%, #0f1c3d 100%);
      border-radius: 25px; padding: 40px 30px; color: #fff;
      box-shadow: 0 0 40px rgba(0, 150, 255, 0.15); margin: 40px auto;
    }
    .nav-btn {
      width: 55px; height: 55px; border-radius: 12px; border: 2px solid #3b82f6;
      background: transparent; color: #3b82f6; display: flex; align-items: center;
      justify-content: center; font-size: 22px; transition: 0.3s;
    }
    .review-card {
      background: rgba(255, 255, 255, 0.05); border-radius: 20px; padding: 25px;
      margin: 20px 0; backdrop-filter: blur(10px);
      display: none;
    }
    .review-card.active { display: block; animation: fadeIn 0.4s; }
    .stars { color: #38bdf8; font-size: 18px; margin-top: 10px; }
    .all-reviews-btn {
      background: linear-gradient(90deg, #38bdf8, #3b82f6); border: none;
      border-radius: 12px; padding: 12px 25px; color: white; font-weight: 500;
    }

    .analytics-btn-group, .history-btn-group {
      display: flex; gap: 8px; flex-wrap: nowrap; margin-bottom: 20px;
      overflow-x: auto; padding-bottom: 5px;
    }
    .analytics-btn-group::-webkit-scrollbar,
    .history-btn-group::-webkit-scrollbar { display: none; }    

    .btn-period, .btn-filter {
      background: rgba(255, 255, 255, 0.05); border: 1px solid #3b82f6;
      color: #fff; padding: 8px 12px; border-radius: 10px;
      font-size: 13px; transition: 0.3s; white-space: nowrap; flex: 1; text-align: center;
    }
    .btn-period.active, .btn-filter.active { background: #3b82f6; }
    
    .stat-box {
      background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 15px; padding: 15px; margin-bottom: 12px;
    }
    .stat-label { color: #9fb3ff; font-size: 13px; margin-bottom: 4px; }
    .stat-value { font-size: 18px; font-weight: bold; }
    .text-success-custom { color: #00ff88; }
    .text-danger-custom { color: #ff4d4d; }

    .stat-period-box {
      background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px; padding: 20px; margin-bottom: 15px;
    }
    .period-name { font-size: 18px; font-weight: bold; color: #4db8ff; margin-bottom: 12px; }
    .period-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .period-label { color: #9fb3ff; font-size: 14px; }
    .period-value { font-weight: bold; font-size: 16px; }
    .period-value small { color: #9fb3ff; font-weight: normal; margin-left: 5px; }

    .mobile-bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; z-index: 9999; }
    .mobile-toggle {
        width: 100%; background: linear-gradient(180deg, #2a3f6b, #243b63);
        color: #cfe9ff; border: none; padding: 18px 20px; display: flex;
        justify-content: space-between; align-items: center;
        border-top-left-radius: 20px; border-top-right-radius: 20px;
    }
    .mobile-icon {
        width: 32px; height: 32px; background: rgba(255,255,255,0.1);
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
    }
    .mobile-content { background: linear-gradient(180deg, #182848 0%, #101c3a 100%); padding: 20px; }
    .mobile-item { padding: 14px 15px; border-radius: 12px; color: #cfe9ff; margin-bottom: 10px; text-decoration: none; display: block;}
    .mobile-item.active { background: rgba(100, 170, 255, 0.2); }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    @media (max-width: 380px) {
      .btn-period, .btn-filter { font-size: 11px; padding: 6px 4px; }
      .history-btn-group { gap: 4px; }
      .action-wrapper { gap: 15px; }
      .action-box { width: 60px; height: 60px; font-size: 20px; }
      .action-item .label { font-size: 12px; }
    }
  </style>
</head>
<body>

<div class="app-container">

    <div class="card-custom text-center">
      <div class="small-text mb-2">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</div>
      <div class="balance" id="totalBalance">$0.00</div>
      <div class="action-wrapper mt-4">      
        <div class="action-item">
          <button class="action-box" onclick="window.location.href='deposit.html'">‚Üë</button>
          <div class="label">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</div>
        </div>
        <div class="action-item">
          <button class="action-box" onclick="window.location.href='withdraw.html'">‚Üì</button>
          <div class="label">–í—ã–≤–µ—Å—Ç–∏</div>
        </div>
        <div class="action-item">
          <button class="action-box" onclick="window.location.href='exchange.html'">‚áÑ</button>
          <div class="label">–û–±–º–µ–Ω—è—Ç—å</div>
        </div>
      </div>
    </div>

    <div class="profile-box">
      <h6 class="mb-3">–ü—Ä–æ—Ñ–∏–ª—å</h6>
      <div class="mb-3"><div class="fw-bold" id="userIdDisplay">0</div><div class="small-text">ID –∞–∫–∫–∞—É–Ω—Ç–∞</div></div>
      <div class="mb-3"><div class="fw-bold" id="stats">0 / <span style="color: #00ff88">0</span> / <span style="color: #ff4d4d">0</span></div><div class="small-text">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div></div>
      <div class="mb-3"><div class="fw-bold" id="tradingVolume">0.00 USDT</div><div class="small-text">–û–±—ä–µ–º —Ç–æ—Ä–≥–æ–≤</div></div>
      <div><div class="text-warning fw-bold" id="verification">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</div><div class="small-text">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–æ–π—Ç–∏</div></div>
    </div>

    <div class="profile-box" style="background: #1a2d4d !important; font-size: 12px;">
      <h6 class="mb-2" style="color: #69b7ff;">DEBUG INFO</h6>
      <div style="color: #9fb3ff; line-height: 1.6;">
        <div>Telegram ID: <span id="debugTelegramId">–Ω–µ –∑—ñ –¥–æ—Å—Ç—É–ø–µ–Ω</span></div>
        <div>User ID: <span id="debugUserId">–∑–∞–≥—Ä—É–∑–∫–∞...</span></div>
        <div>–°—Ç–∞—Ç—É—Å: <span id="debugStatus">–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</span></div>
      </div>
    </div>

    <div class="section-card">
      <h5 class="section-title">–í–∞–ª—é—Ç–Ω—ã–µ —Å—á–µ—Ç–∞</h5>
      <div class="asset-item">
        <div class="asset-left d-flex align-items-center gap-3">
          <div class="coin gold">‚ÇΩ</div>
          <div><div class="asset-name">–†–æ—Å—Å–∏–π—Å–∫–∏–π —Ä—É–±–ª—å</div><div class="asset-price" id="rubPrice">... ‚ÇΩ</div></div>
        </div>
        <div class="asset-right" id="rubBalance">0.00 ‚ÇΩ</div>
      </div>
    </div>

    <div class="section-card">
      <h5 class="section-title">–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã</h5>
      <div class="asset-item">
        <div class="asset-left d-flex align-items-center gap-3"><div class="coin btc">‚Çø</div><div><div class="asset-name">Bitcoin</div><div class="asset-price" id="btcPrice">... $</div></div></div>
        <div class="asset-right" id="btcBalance">0.00 $</div>
      </div>
      <div class="asset-item">
        <div class="asset-left d-flex align-items-center gap-3"><div class="coin ton">T</div><div><div class="asset-name">Toncoin</div><div class="asset-price" id="tonPrice">... $</div></div></div>
        <div class="asset-right" id="tonBalance">0.00 $</div>
      </div>
      <div class="asset-item">
        <div class="asset-left d-flex align-items-center gap-3"><div class="coin eth">‚óÜ</div><div><div class="asset-name">Ethereum</div><div class="asset-price" id="ethPrice">... $</div></div></div>
        <div class="asset-right" id="ethBalance">0.00 $</div>
      </div>
      <div class="asset-item">
        <div class="asset-left d-flex align-items-center gap-3"><div class="coin usdt">‚ÇÆ</div><div><div class="asset-name">Tether</div><div class="asset-price" id="usdtPrice">1.00 $</div></div></div>
        <div class="asset-right" id="usdtBalance">0.00 $</div>
      </div>
    </div>

    <div class="reviews-section">
      <div class="section-title">–û—Ç–∑—ã–≤—ã –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
      <div class="section-subtitle">–ß—Ç–æ –≥–æ–≤–æ—Ä—è—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ.</div>
      <div class="d-flex gap-2 mt-3">
        <button class="nav-btn" id="prevReview">‚Üê</button>
        <button class="nav-btn" id="nextReview">‚Üí</button>
      </div>
      <div id="reviewsContainer"></div>
      <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="reviews-footer" id="reviewCounter">–û—Ç–∑—ã–≤—ã 1 –∏–∑ 36</div>
        <button class="all-reviews-btn" onclick="window.location.href='reviews.html'">–í—Å–µ –æ—Ç–∑—ã–≤—ã</button>
      </div>
    </div>

    <div class="section-card">
        <h5 class="section-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏</h5>
        <div class="analytics-btn-group mt-3">
            <button class="btn-period active" onclick="selectPeriod(this, 'all')">–í—Å–µ –≤—Ä–µ–º—è</button>
            <button class="btn-period" onclick="selectPeriod(this, 'year')">–ì–æ–¥</button>
            <button class="btn-period" onclick="selectPeriod(this, 'month')">–ú–µ—Å—è—Ü</button>
            <button class="btn-period" onclick="selectPeriod(this, 'week')">–ù–µ–¥–µ–ª—è</button>
            <button class="btn-period" onclick="selectPeriod(this, 'day')">–î–µ–Ω—å</button>
        </div>
        <div class="stat-box"><div class="stat-label">Win Rate</div><div class="stat-value" id="winRate">0.0%</div></div>
        <div class="stat-box"><div class="stat-label">–°—Ä–µ–¥–Ω—è—è –ø—Ä–∏–±—ã–ª—å</div><div class="stat-value text-success-custom" id="avgProfit">+0.00 USDT</div></div>
        <div class="stat-box"><div class="stat-label">–°—Ä–µ–¥–Ω–∏–π —É–±—ã—Ç–æ–∫</div><div class="stat-value text-danger-custom" id="avgLoss">0.00 USDT</div></div>
        <div class="stat-box"><div class="stat-label">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à</div><div class="stat-value text-success-custom" id="maxWin">+0.00 USDT</div></div>
        <div class="stat-box"><div class="stat-label">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–æ–∏–≥—Ä—ã—à</div><div class="stat-value text-danger-custom" id="maxLoss">0.00 USDT</div></div>
        <div class="stat-box"><div class="stat-label">Profit Factor</div><div class="stat-value" id="profitFactor">0.00</div></div>
    </div>

    <div class="section-card text-center">
        <h5 class="section-title text-start">–ì—Ä–∞—Ñ–∏–∫ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ (P&L)</h5>
        <div id="pnlChartContainer" style="height: 300px; position: relative;">
            <div id="pnlChart" style="width: 100%; height: 100%;"></div>
            <div id="pnlChartPlaceholder" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; color: #9fb3ff; background: #162447;">
                <span>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞</span>
            </div>
        </div>
    </div>

    <div class="section-card">
        <h5 class="section-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º</h5>
        <div class="stat-period-box">
            <div class="period-name">–°–µ–≥–æ–¥–Ω—è</div>
            <div class="period-row"><span class="period-label">–ü—Ä–∏–±—ã–ª—å</span><span class="period-value text-success-custom" id="pProfitToday">+0.00 USDT</span></div>
            <div class="period-row"><span class="period-label">–°–¥–µ–ª–æ–∫</span><span class="period-value" id="pTradesToday">0 <small>(0W / 0L)</small></span></div>
        </div>
        <div class="stat-period-box">
            <div class="period-name">–ù–µ–¥–µ–ª—è</div>
            <div class="period-row"><span class="period-label">–ü—Ä–∏–±—ã–ª—å</span><span class="period-value text-success-custom" id="pProfitWeek">+0.00 USDT</span></div>
            <div class="period-row"><span class="period-label">–°–¥–µ–ª–æ–∫</span><span class="period-value" id="pTradesWeek">0 <small>(0W / 0L)</small></span></div>
        </div>
        <div class="stat-period-box">
            <div class="period-name">–ú–µ—Å—è—Ü</div>
            <div class="period-row"><span class="period-label">–ü—Ä–∏–±—ã–ª—å</span><span class="period-value text-success-custom" id="pProfitMonth">+0.00 USDT</span></div>
            <div class="period-row"><span class="period-label">–°–¥–µ–ª–æ–∫</span><span class="period-value" id="pTradesMonth">0 <small>(0W / 0L)</small></span></div>
        </div>
    </div>

    <div class="section-card">
        <h5 class="section-title">–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</h5>
        <div class="history-btn-group mt-3">
            <button class="btn-filter active" onclick="filterHistory('all')">–í—Å–µ (0)</button>
            <button class="btn-filter" onclick="filterHistory('withdraw')">–í—ã–≤–æ–¥—ã (0)</button>
            <button class="btn-filter" onclick="filterHistory('deposit')">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è (0)</button>
        </div>
        <div id="historyContent" style="min-height: 150px; color: #9fb3ff;">
            <div style="height: 150px; display: flex; align-items: center; justify-content: center;">
                <span>–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—É—Å—Ç–∞</span>
            </div>
        </div>
    </div>

    <div class="mobile-bottom-nav">
        <button class="mobile-toggle collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#mobileMenu">
            <div class="d-flex align-items-center gap-2">
                <div class="mobile-icon">üí∞</div>
                <span class="fw-bold">–ê–∫—Ç–∏–≤—ã</span>
            </div>
            <div class="mobile-arrow">‚åÉ</div>
        </button>
        <div class="collapse" id="mobileMenu">
            <div class="mobile-content">
                <a href="index.html" class="mobile-item active">üí∞ –ê–∫—Ç–∏–≤—ã</a>
                <a href="trading.html" class="mobile-item">üìä –¢–æ—Ä–≥–æ–≤–ª—è</a>
                <a href="staking.html" class="mobile-item">üì¶ –°—Ç–µ–π–∫–∏–Ω–≥</a>
                <div class="mobile-item disabled d-flex justify-content-between">
                    <span>üì¶ –ë–∏–Ω–∞—Ä–Ω—ã–µ –æ–ø—Ü–∏–æ–Ω—ã</span>
                    <span class="mobile-badge">–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</span>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/auth.js"></script>
<script src="/js/api.js"></script>
<script src="/js/balance.js"></script>
<script>
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.ready();
    tg.expand();
  }

  let userId = null;
  let RUB_RATE = 79.10;
  let allTransactions = [];

  function getClientTelegramId() {
    const telegramId = TelegramAuth.getTelegramId();
    if (telegramId) {
      document.getElementById('debugTelegramId').textContent = String(telegramId) + ' ‚úÖ —Ä–µ–∞–ª—å–Ω—ã–π';
    } else {
      document.getElementById('debugTelegramId').textContent = '–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚ö†Ô∏è';
    }
    return telegramId;
  }

  async function resolveUserId() {
    try {
      const user = TelegramAuth.getCurrentUser();
      if (user) {
        document.getElementById('debugUserId').textContent = user.id;
        document.getElementById('debugStatus').textContent = '‚úÖ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
        return user.id;
      }
      throw new Error('User not found');
    } catch (error) {
      document.getElementById('debugStatus').textContent = '‚ùå –æ—à–∏–±–∫–∞';
      throw error;
    }
  }

  const updateEl = (id, val) => { 
    const el = document.getElementById(id); 
    if(el) el.textContent = val; 
  };

  async function updateMarketPrices() {
    try {
        const symbols = ["BTCUSDT", "ETHUSDT", "TONUSDT"];
        const res = await fetch(`https://api.binance.com/api/v3/ticker/price?symbols=${JSON.stringify(symbols)}`);
        const prices = await res.json();
        
        const rubRes = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
        const rubData = await rubRes.json();
        RUB_RATE = rubData.rates.RUB;

        const priceMap = {};
        prices.forEach(p => priceMap[p.symbol] = parseFloat(p.price));

        updateEl('rubPrice', `${RUB_RATE.toFixed(2)} ‚ÇΩ`);
        updateEl('btcPrice', `${priceMap['BTCUSDT'].toLocaleString()} $`);
        updateEl('ethPrice', `${priceMap['ETHUSDT'].toLocaleString()} $`);
        updateEl('tonPrice', `${priceMap['TONUSDT'].toFixed(2)} $`);

        return { btc: priceMap['BTCUSDT'], eth: priceMap['ETHUSDT'], ton: priceMap['TONUSDT'] };
    } catch (e) { return null; }
  }

  async function loadUserData() {
    try {
      const user = window.CURRENT_USER;
      if (!user) {
        console.warn('No user data available');
        return;
      }

      // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π userId
      userId = user.telegram_id;

      // –ü–æ–∫–∞–∑–∞—Ç—å Telegram ID –∫–∞–∫ ID –∞–∫–∫–∞—É–Ω—Ç–∞
      const telegramId = user.telegram_id;
      updateEl('userIdDisplay', telegramId);
      
      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑ API
      try {
        const statsRes = await fetch(`/api/trades/stats/${telegramId}`);
        if (statsRes.ok) {
          const statsPayload = await statsRes.json();
          const s = statsPayload.data || {};
          document.getElementById('stats').innerHTML = `${s.total || 0} / <span style="color: #00ff88">${s.wins || 0}</span> / <span style="color: #ff4d4d">${s.losses || 0}</span>`;
        } else {
          document.getElementById('stats').innerHTML = '0 / <span style="color: #00ff88">0</span> / <span style="color: #ff4d4d">0</span>';
        }
      } catch (e) {
        document.getElementById('stats').innerHTML = '0 / <span style="color: #00ff88">0</span> / <span style="color: #ff4d4d">0</span>';
      }
      
      // –û–±—ä–µ–º —Ç–æ—Ä–≥–æ–≤ (–∏–∑ –ë–î –∏–ª–∏ 0)
      const tradingVol = parseFloat(user.total_volume) || 0;
      updateEl('tradingVolume', `${tradingVol.toFixed(2)} USDT`);
      
      // –°—Ç–∞—Ç—É—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
      const verifEl = document.getElementById('verification');
      if (verifEl) {
          const isVerified = user.verified === true || user.verified === 1;
          verifEl.textContent = isVerified ? '‚úÖ –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω' : '‚ö†Ô∏è –ù–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω';
          verifEl.style.color = isVerified ? "#00ff88" : "#ffc107";
      }

      // –û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—ã –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç
      const market = await updateMarketPrices();
      
      // –ü–æ–∫–∞–∑–∞—Ç—å –æ–±—â–∏–π –±–∞–ª–∞–Ω—Å –≤ USD
      const rbcInUsd = (parseFloat(user.balance_rub) || 0) / RUB_RATE;
      const usdtBalance = parseFloat(user.balance_usdt) || 0;
      const btcInUsd = market ? (parseFloat(user.balance_btc) || 0) * market.btc : 0;
      const totalBalanceUsd = rbcInUsd + usdtBalance + btcInUsd;
      
      updateEl('totalBalance', `$${totalBalanceUsd.toFixed(2)}`);
      
      console.log('‚úÖ User data loaded:', user);
    } catch (e) {
      console.error('‚ùå Error loading user data:', e.message);
      document.getElementById('userIdDisplay').textContent = '‚ùå –û—à–∏–±–∫–∞';
    }
  }

  function selectPeriod(btn, period) {
    document.querySelectorAll('.btn-period').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    loadAnalyticsData(period);
  }

  async function loadAnalyticsData(period = 'all') {
    if (!userId) return;
    try {
        const res = await fetch(`/api/trades/analytics/${userId}?period=${period}`);
        if (!res.ok) return;
        const payload = await res.json();
        const a = payload?.data || {};

        updateEl('winRate', `${a.winRate || 0}%`);
        updateEl('avgProfit', `+${a.avgProfit || '0.00'} USDT`);
        updateEl('avgLoss', `-${a.avgLoss || '0.00'} USDT`);
        updateEl('maxWin', `+${a.maxWin || '0.00'} USDT`);
        updateEl('maxLoss', `-${a.maxLoss || '0.00'} USDT`);
        updateEl('profitFactor', a.profitFactor || '0.00');
    } catch (e) { console.error('loadAnalyticsData error:', e); }
  }

  async function loadPeriodStats() {
    if (!userId) return;
    try {
      // Load stats for each period
      const periods = ['day', 'week', 'month'];
      const periodMap = { day: 'Today', week: 'Week', month: 'Month' };
      
      for (const period of periods) {
        const res = await fetch(`/api/trades/analytics/${userId}?period=${period}`);
        if (res.ok) {
          const payload = await res.json();
          const a = payload.data || {};
          const profit = parseFloat(a.totalProfit) - parseFloat(a.totalLoss) || 0;
          const profitStr = profit >= 0 ? `+${profit.toFixed(2)}` : profit.toFixed(2);
          const profitColor = profit >= 0 ? 'text-success-custom' : 'text-danger-custom';
          
          const elProfit = document.getElementById(`pProfit${periodMap[period]}`);
          const elTrades = document.getElementById(`pTrades${periodMap[period]}`);
          
          if (elProfit) {
            elProfit.textContent = `${profitStr} USDT`;
            elProfit.className = `period-value ${profitColor}`;
          }
          if (elTrades) {
            elTrades.innerHTML = `${a.totalTrades} <small>(${a.wins}W / ${a.losses}L)</small>`;
          }
        }
      }
    } catch (e) { console.error('loadPeriodStats error:', e); }
  }

  let pnlChart = null;
  
  async function loadPnlChart() {
    if (!userId) {
      console.log('loadPnlChart: no userId');
      return;
    }
    try {
      console.log('loadPnlChart: fetching for userId', userId);
      const res = await fetch(`/api/trades/pnl-history/${userId}`);
      if (!res.ok) {
        console.log('loadPnlChart: response not ok', res.status);
        return;
      }
      
      const payload = await res.json();
      console.log('loadPnlChart: payload', payload);
      const history = payload?.data?.history || [];
      
      const placeholder = document.getElementById('pnlChartPlaceholder');
      const container = document.getElementById('pnlChart');
      
      if (history.length < 1) {
        placeholder.style.display = 'flex';
        return;
      }
      
      placeholder.style.display = 'none';
      
      // Clear container
      container.innerHTML = '';
      
      // Create chart
      const chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: container.clientHeight,
        layout: {
          background: { type: 'solid', color: '#162447' },
          textColor: '#9fb3ff'
        },
        grid: {
          vertLines: { color: 'rgba(255,255,255,0.05)' },
          horzLines: { color: 'rgba(255,255,255,0.05)' }
        },
        crosshair: {
          mode: LightweightCharts.CrosshairMode.Normal
        },
        rightPriceScale: {
          borderColor: 'rgba(255,255,255,0.1)'
        },
        timeScale: {
          borderColor: 'rgba(255,255,255,0.1)',
          timeVisible: false
        },
        handleScroll: true,
        handleScale: true
      });
      
      // Determine color based on final P&L
      const finalPnl = parseFloat(history[history.length - 1]?.cumulative) || 0;
      const lineColor = finalPnl >= 0 ? '#00ff88' : '#ff4d4d';
      const topColor = finalPnl >= 0 ? 'rgba(0, 255, 136, 0.4)' : 'rgba(255, 77, 77, 0.4)';
      const bottomColor = finalPnl >= 0 ? 'rgba(0, 255, 136, 0.0)' : 'rgba(255, 77, 77, 0.0)';
      
      // Create area series
      const areaSeries = chart.addAreaSeries({
        lineColor: lineColor,
        topColor: topColor,
        bottomColor: bottomColor,
        lineWidth: 2,
        priceFormat: {
          type: 'custom',
          formatter: (price) => price.toFixed(2) + ' USDT'
        }
      });
      
      // Transform data for lightweight-charts
      const chartData = history.map(h => {
        const d = new Date(h.date);
        return {
          time: `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`,
          value: parseFloat(h.cumulative)
        };
      });
      
      areaSeries.setData(chartData);
      chart.timeScale().fitContent();
      
      // Handle resize
      window.addEventListener('resize', () => {
        chart.applyOptions({ width: container.clientWidth });
      });
      
    } catch (e) { console.error('loadPnlChart error:', e); }
  }

  function updateFilterCounts() {
    const counts = {
        all: allTransactions.length,
        deposit: allTransactions.filter(t => t.type === 'deposit').length,
        withdraw: allTransactions.filter(t => t.type === 'withdrawal').length
    };
    const filters = document.querySelectorAll('.btn-filter');
    if(filters.length >= 3) {
        filters[0].innerText = `–í—Å–µ (${counts.all})`;
        filters[1].innerText = `–í—ã–≤–æ–¥—ã (${counts.withdraw})`;
        filters[2].innerText = `–ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è (${counts.deposit})`;
    }
  }

  function filterHistory(type) {
    const container = document.getElementById('historyContent');
    document.querySelectorAll('.btn-filter').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('onclick').includes(`'${type}'`));
    });

    const normalizedType = type === 'withdraw' ? 'withdrawal' : type;
    const filtered = type === 'all' ? allTransactions : allTransactions.filter(tx => tx.type === normalizedType);
    if (filtered.length === 0) {
      container.innerHTML = '<div style="height: 150px; display: flex; align-items: center; justify-content: center;"><span>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</span></div>';
      return;
    }

    container.innerHTML = filtered.map(tx => {
      const isDep = tx.type === 'deposit';
      const created = tx.createdAt ? new Date(tx.createdAt) : null;
      const dateStr = created ? created.toLocaleDateString('ru-RU') : '';
      const timeStr = created ? created.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }) : '';
      return `
        <div class="history-item">
          <div class="history-icon">${isDep ? 'üì•' : 'üì§'}</div>
          <div class="history-info">
            <div class="history-type">${isDep ? '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ' : '–í—ã–≤–æ–¥'}</div>
            <div class="history-date">${dateStr},<br>${timeStr}</div>
          </div>
          <div class="history-amount">
            <div class="amount-val ${isDep ? 'text-plus' : 'text-minus'}">${isDep ? '+' : '-'}${parseFloat(tx.amount).toFixed(2)}</div>
            <div class="amount-cur">${tx.currency || 'RUB'}</div>
          </div>
        </div>`;
    }).join('');
  }

  const reviewsContainer = document.getElementById('reviewsContainer');
  let currentIdx = 0;
  const totalReviews = 36;

  function initReviews() {
    reviewsContainer.innerHTML = '';
    for (let i = 1; i <= totalReviews; i++) {
      const card = document.createElement('div');
      card.className = `review-card ${i === 1 ? 'active' : ''}`;
      card.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
          <div><div class="review-name fw-bold">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #${1000 + i}</div><div class="review-role">–ö–ª–∏–µ–Ω—Ç Nexo</div></div>
          <div class="review-date">18.10.2025</div>
        </div>
        <p class="mt-3 mb-2">–û—Ç–ª–∏—á–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞! –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç –±—ã—Å—Ç—Ä–æ, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ—á–µ–Ω—å —É–¥–æ–±–Ω—ã–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π.</p>
        <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>`;
      reviewsContainer.appendChild(card);
    }
  }

  function updateReview(dir) {
    const cards = document.querySelectorAll('.review-card');
    if(cards.length === 0) return;
    cards[currentIdx].classList.remove('active');
    currentIdx = (currentIdx + dir + totalReviews) % totalReviews;
    cards[currentIdx].classList.add('active');
    document.getElementById('reviewCounter').textContent = `–û—Ç–∑—ã–≤—ã ${currentIdx + 1} –∏–∑ ${totalReviews}`;
  }

  document.getElementById('nextReview').onclick = () => updateReview(1);
  document.getElementById('prevReview').onclick = () => updateReview(-1);

  window.addEventListener('DOMContentLoaded', async () => {
    try {
      console.log('üöÄ Initializing Nexo Trade...');
      
      // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
      if (!TelegramAuth.isAuthenticated()) {
        console.log('üîÑ Not authenticated, logging in...');
        await TelegramAuth.login();
      } else {
        console.log('‚úÖ Already authenticated');
        window.CURRENT_USER = TelegramAuth.getCurrentUser();
        window.AUTH_TOKEN = TelegramAuth.getToken();
      }

      // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      await TelegramAuth.refreshUser();
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
      await loadUserData();
      loadAnalyticsData('all');
      loadPeriodStats();
      loadPnlChart();
      initReviews();
      console.log('‚úÖ Init complete');
    } catch (e) {
      console.error('‚ùå Initialization error:', e.message);
      document.getElementById('debugStatus').textContent = '‚ùå –æ—à–∏–±–∫–∞: ' + e.message;
      
      // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ
      alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + e.message);
    }
  });

  setInterval(() => {
    if (userId) loadUserData();
  }, 5000);
</script>
</body>
</html>
